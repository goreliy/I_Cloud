

map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}


upstream grafana {
  server localhost:3000;
}



upstream strim2 {
  server localhost:5173;
}





server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

#    access_log  /var/log/nginx/host.access.log  ;
#    error_log  /var/log/nginx/host.error.log  ;

    location / {
#        root   /usr/share/nginx/html;
#        index  index.html index.htm;

   proxy_set_header X-Is-Reverse-Proxy "true";
   proxy_set_header Host $host;
   proxy_set_header X-Real-IP $remote_addr;
   proxy_set_header X-Forwarded-For $remote_addr;
   proxy_set_header X-Forwarded-Proto $scheme;
   proxy_pass http://192.168.66.209:85;
    }

#location /login {
#   allow 192.168.66.97;
#   deny all;
# }
#location /users {
#   allow 192.168.66.97;
#   deny all;
# }


location /strim {

   proxy_set_header X-Is-Reverse-Proxy "true";
   proxy_set_header Host $host;
   proxy_set_header X-Real-IP $remote_addr;
   proxy_set_header X-Forwarded-For $remote_addr;
   proxy_set_header X-Forwarded-Proto $scheme;
   proxy_pass http://192.168.66.215:5173/strim;




#    rewrite  ^/stream/(.*)  /$1 break;
#    proxy_set_header Host $http_host;
#    proxy_pass http://192.168.66.97:5173;
  }



location /strim2 {

   proxy_set_header X-Is-Reverse-Proxy "true";
   proxy_set_header Host $host;
   proxy_set_header X-Real-IP $remote_addr;
   proxy_set_header X-Forwarded-For $remote_addr;
   proxy_set_header X-Forwarded-Proto $scheme;
   proxy_pass http://192.168.66.216:5173/strim2;
   proxy_http_version 1.1;
   proxy_set_header Upgrade $http_upgrade;
   proxy_set_header Connection 'upgrade';



#    rewrite  ^/strim2/(.*)  /$1 break;
#    proxy_set_header Host $http_host;
#    proxy_pass http://192.168.66.97:5173;
  }



location /strim2/static {

   proxy_set_header X-Is-Reverse-Proxy "true";
   proxy_set_header Host $host;
   proxy_set_header X-Real-IP $remote_addr;
   proxy_set_header X-Forwarded-For $remote_addr;
   proxy_set_header X-Forwarded-Proto $scheme;
   proxy_pass http://192.168.66.216:5173/strim2;
  }




    location /cloud/ {
   proxy_set_header X-Is-Reverse-Proxy "true";
   proxy_set_header Host $host;
   proxy_set_header X-Real-IP $remote_addr;
   proxy_set_header X-Forwarded-For $remote_addr;
   proxy_set_header X-Forwarded-Proto $scheme;
   proxy_pass http://192.168.66.209/;
    }

    location /tech/ {
   proxy_set_header X-Is-Reverse-Proxy "true";
   proxy_set_header Host $host;
   proxy_set_header X-Real-IP $remote_addr;
   proxy_set_header X-Forwarded-For $remote_addr;
   proxy_set_header X-Forwarded-Proto $scheme;
   proxy_pass http://192.168.66.202/;
    }


    location /cloud2/ {
   rewrite  ^/cloud2/(.*)  /$1 break;
   proxy_set_header X-Is-Reverse-Proxy "true";
   proxy_set_header Host $host;
   proxy_set_header X-Real-IP $remote_addr;
   proxy_set_header X-Forwarded-For $remote_addr;
   proxy_set_header X-Forwarded-Proto $scheme;
   proxy_set_header X-Forwarded-Prefix /cloud2;
   proxy_pass http://192.168.66.205:8000;
    }
    
    location = /cloud2 {
   return 301 /cloud2/;
    }





location /grafana/ {
    rewrite  ^/grafana/(.*)  /$1 break;
    proxy_set_header Host $http_host;
    proxy_pass http://192.168.66.205:3000;
  }

  # Proxy Grafana Live WebSocket connections.
  location /grafana/api/live/ {
    rewrite  ^/grafana/(.*)  /$1 break;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host $http_host;
    proxy_pass http://192.168.66.205:3000;
  }




location /nginxgor_status {
stub_status on;
access_log off;
  }





#location /assets {
#     /usr/share/nginx/html/assets;
#}


#location /assets {
#    proxy_pass https://192.168.66.209:85/assets/;
#}


    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ {
    #    proxy_pass   http://127.0.0.1;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    #location ~ \.php$ {
    #    root           html;
    #    fastcgi_pass   127.0.0.1:9000;
    #    fastcgi_index  index.php;
    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
    #    include        fastcgi_params;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny  all;
    #}
}

server {
    listen       443 ssl;
#    listen  [::]:80;
    server_name  localhost;

#    access_log  /var/log/nginx/host.access443.log  ;
#    error_log  /var/log/nginx/host.error443.log  ;

    ssl_certificate           /etc/nginx/cert.crt;
    ssl_certificate_key       /etc/nginx/cert.key;
#    ssl on;
    ssl_session_cache  builtin:1000  shared:SSL:10m;
    ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
    ssl_prefer_server_ciphers on;

    location / {
#        root   /usr/share/nginx/html;
#        index  index.html index.htm;

   proxy_set_header X-Is-Reverse-Proxy "true";
   proxy_set_header Host $host;
   proxy_set_header X-Real-IP $remote_addr;
   proxy_set_header X-Forwarded-For $remote_addr;
#   proxy_set_header X-Forwarded-Proto $scheme;

   proxy_pass http://192.168.66.209:85;
    }


    location /cloud2/ {
   rewrite  ^/cloud2/(.*)  /$1 break;
   proxy_set_header X-Is-Reverse-Proxy "true";
   proxy_set_header Host $host;
   proxy_set_header X-Real-IP $remote_addr;
   proxy_set_header X-Forwarded-For $remote_addr;
   proxy_set_header X-Forwarded-Proto $scheme;
   proxy_set_header X-Forwarded-Prefix /cloud2;
   proxy_pass http://192.168.66.205:8000;
    }
    
    location = /cloud2 {
   return 301 /cloud2/;
    }




    location /tech/ {
   proxy_set_header X-Is-Reverse-Proxy "true";
   proxy_set_header Host $host;
   proxy_set_header X-Real-IP $remote_addr;
   proxy_set_header X-Forwarded-For $remote_addr;
   proxy_set_header X-Forwarded-Proto $scheme;

   proxy_pass http://192.168.66.202/;
    }







    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ {
    #    proxy_pass   http://127.0.0.1;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    #location ~ \.php$ {
    #    root           html;
    #    fastcgi_pass   127.0.0.1:9000;
    #    fastcgi_index  index.php;
    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
    #    include        fastcgi_params;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny  all;
    #}
}





server {
    listen 80;
    server_name gorelyi;

    location /vis {
        proxy_set_header X-Is-Reverse-Proxy "true";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://192.168.66.217/vis;
    }

    location /vis/login {
        proxy_set_header X-Is-Reverse-Proxy "true";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://192.168.66.217/login;
    }
}
