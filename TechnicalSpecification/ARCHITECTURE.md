# Архитектурный план системы IBolid Cloud

## Общая архитектура

Система IBolid Cloud построена по архитектуре **Monolithic Backend + Server-Side Rendered Frontend** с четким разделением слоев:

```
┌─────────────────────────────────────────────────────────────┐
│                        Клиентский слой                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Web Browser │  │  IoT Device  │  │  Mobile App  │     │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘     │
│         │                 │                 │              │
│         └─────────────────┼─────────────────┘              │
│                           │                                 │
└───────────────────────────┼─────────────────────────────────┘
                            │
                            │ HTTP/HTTPS
                            │
┌───────────────────────────▼─────────────────────────────────┐
│                    Прикладной слой (FastAPI)                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                    Middleware Layer                  │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────┐ │   │
│  │  │   Logging    │  │ Rate Limiting │  │   CORS   │ │   │
│  │  └──────────────┘  └──────────────┘  └──────────┘ │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                    Router Layer                      │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐         │   │
│  │  │   Auth    │  │ Channels │  │  Feeds   │  ...    │   │
│  │  └──────────┘  └──────────┘  └──────────┘         │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                   Service Layer                      │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐         │   │
│  │  │ Channel  │  │   Feed   │  │ Widget   │  ...    │   │
│  │  │ Service  │  │ Service  │  │ Service  │         │   │
│  │  └──────────┘  └──────────┘  └──────────┘         │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                    Data Layer                        │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐         │   │
│  │  │  Models  │  │ Schemas  │  │ Database │         │   │
│  │  └──────────┘  └──────────┘  └──────────┘         │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            │ SQLAlchemy ORM
                            │
┌───────────────────────────▼─────────────────────────────────┐
│                    Слой данных                              │
│  ┌──────────────────┐         ┌──────────────────┐        │
│  │  Основная БД      │         │  Архивная БД     │        │
│  │  (SQLite/Postgres)│         │  (SQLite/Postgres)│        │
│  └──────────────────┘         └──────────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

---

## Компоненты системы

### 1. Клиентский слой

#### 1.1. Web Browser
- **Технологии**: HTML, CSS, JavaScript
- **Фреймворки**: Bootstrap 5, Chart.js
- **Взаимодействие**: HTTP запросы к REST API
- **Функции**:
  - Отображение веб-интерфейса
  - Визуализация данных (графики)
  - Управление каналами и виджетами
  - Администрирование системы

#### 1.2. IoT Device
- **Протокол**: HTTP/HTTPS
- **Формат**: REST API (ThingSpeak совместимый)
- **Функции**:
  - Отправка данных в каналы
  - Получение данных из каналов
  - Использование API ключей для аутентификации

#### 1.3. Mobile App (потенциально)
- **Протокол**: HTTP/HTTPS
- **Формат**: REST API
- **Функции**: Аналогично Web Browser

---

### 2. Прикладной слой (FastAPI)

#### 2.1. Middleware Layer

**Request Logging Middleware**
- Логирует все входящие запросы
- Сохраняет метрики в БД
- Используется для мониторинга и отладки

**Rate Limiting Middleware**
- Ограничивает частоту запросов
- Защита от DDoS атак
- Работает только в production режиме

**CORS Middleware**
- Управляет Cross-Origin запросами
- Настраивается через конфигурацию
- Поддержка различных источников

**Root Path Middleware**
- Поддержка работы за реверс-прокси
- Корректная обработка URL
- Настраивается через ROOT_PATH

#### 2.2. Router Layer

**API Routers:**
- `auth.py` — аутентификация и авторизация
- `channels.py` — управление каналами
- `feeds.py` — работа с данными
- `widgets.py` — управление виджетами
- `automation.py` — правила автоматизации
- `admin.py` — администрирование
- `admin_archive.py` — управление архивацией
- `control.py` — безопасное выполнение кода виджетов
- `stress_test.py` — стресс-тестирование

**Web Routers:**
- `web.py` — веб-страницы (HTML)

#### 2.3. Service Layer

**Бизнес-логика разделена по доменам:**

**Channel Service**
- Создание, чтение, обновление, удаление каналов
- Управление API ключами
- Проверка прав доступа

**Feed Service**
- Создание записей данных
- Получение данных с фильтрацией
- Агрегация данных

**Data Processor**
- Обработка и агрегация данных
- Вычисление статистики
- Форматирование для экспорта

**Auth Service**
- Создание пользователей
- Аутентификация
- Генерация JWT токенов

**Widget Service**
- Создание и управление виджетами
- Версионирование виджетов
- Генерация через AI

**Automation Service**
- Обработка правил автоматизации
- Выполнение действий
- PID контроллеры

**Archive Service**
- Архивация старых данных
- Миграция данных
- Управление архивной БД

**Upload Service**
- Загрузка файлов
- Обработка изображений
- Хранение файлов

#### 2.4. Data Layer

**Models (SQLAlchemy)**
- Определение структуры данных
- Связи между таблицами
- Миграции через Alembic

**Schemas (Pydantic)**
- Валидация входных данных
- Сериализация выходных данных
- Документация API

**Database**
- Подключение к БД
- Управление сессиями
- Пул соединений

---

### 3. Слой данных

#### 3.1. Основная база данных

**Назначение**: Хранение актуальных данных системы

**Таблицы:**
- `users` — пользователи
- `user_profiles` — профили пользователей
- `channels` — каналы данных
- `feeds` — записи данных
- `api_keys` — API ключи
- `custom_widgets` — пользовательские виджеты
- `widget_versions` — версии виджетов
- `automation_rules` — правила автоматизации
- `ai_services` — AI сервисы
- `request_logs` — логи запросов
- `archive_settings` — настройки архивации
- `stress_test_runs` — результаты стресс-тестов

**Поддержка:**
- SQLite (по умолчанию)
- PostgreSQL (опционально)

#### 3.2. Архивная база данных

**Назначение**: Хранение старых данных

**Структура:**
- Аналогична основной БД
- Данные мигрируются из основной БД
- Настраиваемый период хранения

**Поддержка:**
- SQLite (по умолчанию)
- PostgreSQL (опционально)

---

## Потоки данных

### 1. Поток записи данных

```
IoT Device
    │
    │ HTTP POST/GET /update
    │ api_key, field1-8, location, status
    │
    ▼
Rate Limiting Middleware
    │
    ▼
Feeds Router
    │
    ▼
API Key Verification
    │
    ▼
MemBuffer (если включен)
    │
    │ Батчинг записей
    │
    ▼
Feed Service
    │
    ▼
Automation Service (обработка правил)
    │
    ▼
Database (Feeds Table)
    │
    ▼
Response (entry_id)
```

### 2. Поток чтения данных

```
Web Browser / IoT Device
    │
    │ HTTP GET /channels/{id}/feeds.json
    │ JWT Token или Read API Key
    │
    ▼
Feeds Router
    │
    ▼
Access Control (проверка прав)
    │
    ▼
Feed Service
    │
    │ Фильтрация по дате, полям
    │ Агрегация (average, sum, median)
    │
    ▼
Data Processor
    │
    │ Форматирование данных
    │
    ▼
Response (JSON/CSV/XML)
```

### 3. Поток создания виджета

```
Web Browser
    │
    │ HTTP POST /api/channels/{id}/widgets
    │ JWT Token
    │ Form Data: name, type, file, bindings
    │
    ▼
Widgets Router
    │
    ▼
Access Control (проверка владельца канала)
    │
    ▼
Upload Service
    │
    │ Загрузка SVG файла
    │ Сохранение в static/uploads
    │
    ▼
Widget Service
    │
    │ Создание записи виджета
    │ Создание версии виджета
    │
    ▼
Database (CustomWidgets Table)
    │
    ▼
Response (Widget Data)
```

### 4. Поток автоматизации

```
Data Entry (Feed Service)
    │
    │ Новая запись данных
    │
    ▼
Automation Service
    │
    │ Получение активных правил канала
    │ Сортировка по приоритету
    │
    ▼
For each rule:
    │
    ├─ Threshold Rule
    │  │ Проверка условия
    │  │ Выполнение действия
    │  │
    ├─ PID Controller
    │  │ Вычисление PID
    │  │ Установка значения
    │  │
    └─ Expression
       │ Вычисление выражения
       │ Установка значения
       │
    ▼
Feed Service (создание новой записи с результатом)
    │
    ▼
Database
```

### 5. Поток архивации

```
Archive Scheduler (каждый N секунд)
    │
    │ Проверка настроек архивации
    │
    ▼
Archive Service
    │
    │ Определение данных для архивации
    │ (старше retention_days дней)
    │
    ▼
Archive Backend
    │
    ├─ SQLite Backend
    │  │ Копирование данных в архивную БД
    │  │
    └─ PostgreSQL Backend
       │ Копирование данных в архивную БД
       │
    ▼
Migration Service
    │
    │ Удаление данных из основной БД
    │ (если copy_then_delete = true)
    │
    ▼
Database (удаление старых данных)
```

---

## Интеграция компонентов

### Связь Frontend и Backend

```
Frontend (Jinja2 Templates)
    │
    │ Server-Side Rendering
    │
    ▼
Backend (FastAPI)
    │
    │ Рендеринг HTML
    │ Передача данных в шаблоны
    │
    ▼
Response (HTML + Data)
```

**Клиентский JavaScript:**
```
Frontend JavaScript
    │
    │ Fetch API / XMLHttpRequest
    │
    ▼
Backend REST API
    │
    │ Обработка запроса
    │ Валидация данных
    │ Бизнес-логика
    │
    ▼
Response (JSON)
    │
    │ Обновление UI
    │ Обновление графиков
    │ Обновление виджетов
```

### Связь Services и Models

```
Service Layer
    │
    │ Вызов методов моделей
    │ Использование ORM
    │
    ▼
SQLAlchemy Models
    │
    │ SQL запросы
    │
    ▼
Database
```

### Связь Routers и Services

```
Router (Endpoint Handler)
    │
    │ Вызов сервиса
    │ Обработка результата
    │ Формирование ответа
    │
    ▼
Service (Business Logic)
    │
    │ Выполнение бизнес-логики
    │ Работа с моделями
    │
    ▼
Model / Database
```

---

## Масштабируемость

### Горизонтальное масштабирование

**Текущая архитектура:**
- Stateless backend (FastAPI)
- Внешняя база данных
- Возможность запуска нескольких инстансов

**Ограничения:**
- In-memory буфер не синхронизируется между инстансами
- Сессии пользователей не сохраняются между инстансами (используется JWT)

**Решения:**
- Использование внешнего кэша (Redis) для буфера
- Использование внешнего хранилища сессий (если требуется)
- Балансировка нагрузки через nginx/HAProxy

### Вертикальное масштабирование

**Оптимизации:**
- Увеличение пула соединений БД
- Увеличение размера буфера записи
- Оптимизация SQL запросов
- Использование индексов БД

---

## Безопасность

### Аутентификация

**JWT токены:**
- Используются для веб-интерфейса
- Хранятся в localStorage браузера
- Время жизни настраивается
- Подпись через секретный ключ

**API ключи:**
- Используются для устройств
- Хранятся в БД в открытом виде (можно улучшить)
- Типы: read/write
- Можно деактивировать

### Авторизация

**Проверка прав:**
- Владелец канала имеет полный доступ
- Публичные каналы доступны всем (если AUTH_ENABLED=false)
- Приватные каналы доступны только владельцу
- Администраторы имеют доступ ко всем ресурсам

### Защита данных

**Валидация:**
- Все входные данные валидируются через Pydantic
- SQL инъекции предотвращаются через ORM
- XSS защита через экранирование в шаблонах

**Хеширование:**
- Пароли хешируются через bcrypt
- API ключи можно зашифровать (опционально)

---

## Мониторинг и логирование

### Логирование

**Request Logging:**
- Все API запросы логируются в БД
- Метрики: метод, URL, код ответа, время ответа
- Доступны в админ-панели

**Application Logging:**
- Логи приложения (stdout/stderr)
- Можно настроить через uvicorn

### Мониторинг

**Системные метрики:**
- CPU использование
- Использование памяти
- Использование диска
- Отображаются в админ-панели

**Метрики приложения:**
- Количество пользователей
- Количество каналов
- Количество записей данных
- Количество API запросов
- Среднее время ответа

---

## Развертывание

### Локальное развертывание

```
1. Установка зависимостей (pip install -r requirements.txt)
2. Настройка .env файла
3. Инициализация БД (alembic upgrade head)
4. Запуск приложения (uvicorn app.main:app)
```

### Production развертывание

```
1. Настройка реверс-прокси (nginx)
2. Настройка SSL сертификатов
3. Настройка переменных окружения
4. Запуск через systemd/supervisor
5. Настройка мониторинга
6. Настройка резервного копирования БД
```

### Docker развертывание (потенциально)

```
1. Создание Dockerfile
2. Настройка docker-compose.yml
3. Запуск контейнеров
4. Настройка volumes для данных
```

---

## Расширяемость

### Добавление новых endpoints

1. Создать схему в `schemas/`
2. Создать сервис в `services/`
3. Создать роутер в `routers/`
4. Подключить роутер в `main.py`

### Добавление новых моделей

1. Создать модель в `models/`
2. Создать миграцию (alembic revision --autogenerate)
3. Применить миграцию (alembic upgrade head)

### Добавление новых функций

1. Определить место в архитектуре
2. Реализовать в соответствующем сервисе
3. Добавить endpoints (если требуется)
4. Обновить документацию

---

## Заключение

Архитектура системы IBolid Cloud обеспечивает:

- **Модульность**: Четкое разделение ответственности
- **Масштабируемость**: Возможность горизонтального и вертикального масштабирования
- **Безопасность**: Многоуровневая защита данных
- **Производительность**: Оптимизации для высокой нагрузки
- **Расширяемость**: Легкое добавление новых функций
- **Поддерживаемость**: Понятная структура кода

Система готова к использованию в production среде с правильной настройкой и мониторингом.

