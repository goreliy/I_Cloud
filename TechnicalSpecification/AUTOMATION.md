# Техническое описание: Модуль автоматизации и PID регуляторы

## Общая информация

Модуль автоматизации позволяет создавать правила для автоматической обработки данных каналов. Система поддерживает три типа правил:
1. **Пороговые правила** (condition) — простые IF-THEN условия
2. **PID регуляторы** (pid) — пропорционально-интегрально-дифференциальные контроллеры
3. **Математические выражения** (math) — вычисления по формулам

---

## Архитектура модуля

```
Новая запись данных (Feed)
    │
    ▼
Automation Engine
    │
    ├─ Получение активных правил канала
    ├─ Сортировка по приоритету
    │
    ▼
Выполнение правил по порядку:
    │
    ├─ Пороговое правило (condition)
    ├─ PID регулятор (pid)
    └─ Математическое выражение (math)
    │
    ▼
Модификация данных записи
    │
    ▼
Сохранение в БД
```

---

## Типы правил автоматизации

### 1. Пороговые правила (condition)

**Назначение**: Простые условные правила типа "если значение поля больше/меньше порога, то выполнить действие".

**Принцип работы:**
1. Проверяется значение поля-триггера
2. Сравнивается с пороговым значением по условию
3. Если условие выполнено, выполняется действие над целевым полем

**Параметры:**
- `trigger_field` — поле-триггер (field1-8)
- `condition` — условие: `>`, `<`, `>=`, `<=`, `==`, `!=`
- `threshold_value` — пороговое значение (float)
- `target_field` — целевое поле (field1-8)
- `action_type` — тип действия:
  - `set_value` — установить значение
  - `increment` — увеличить на значение
  - `decrement` — уменьшить на значение
- `action_value` — значение для действия (float)

**Примеры использования:**

**Пример 1: Включение обогрева при низкой температуре**
```json
{
  "name": "Включение обогрева",
  "rule_type": "condition",
  "trigger_field": "field1",
  "condition": "<",
  "threshold_value": 18.0,
  "target_field": "field2",
  "action_type": "set_value",
  "action_value": 100.0,
  "priority": 1
}
```
*Если температура (field1) меньше 18°C, установить мощность обогревателя (field2) в 100%*

**Пример 2: Увеличение скорости вентиляции при высокой влажности**
```json
{
  "name": "Увеличение вентиляции",
  "rule_type": "condition",
  "trigger_field": "field2",
  "condition": ">",
  "threshold_value": 70.0,
  "target_field": "field3",
  "action_type": "increment",
  "action_value": 10.0,
  "priority": 2
}
```
*Если влажность (field2) больше 70%, увеличить скорость вентиляции (field3) на 10%*

---

### 2. PID регуляторы (pid)

**Назначение**: Пропорционально-интегрально-дифференциальные контроллеры для точного поддержания заданного значения с учетом динамики процесса.

**Принцип работы PID регулятора:**

PID регулятор вычисляет управляющее воздействие на основе ошибки (разницы между заданным и текущим значением):

```
output = P + I + D

где:
P = Kp × error                    (Пропорциональная составляющая)
I = Ki × integral                 (Интегральная составляющая)
D = Kd × (error - last_error)     (Дифференциальная составляющая)

error = setpoint - current_value  (Ошибка)
integral = накопленная сумма ошибок
last_error = предыдущая ошибка
```

**Компоненты PID:**

1. **Пропорциональная составляющая (P)**
   - Пропорциональна текущей ошибке
   - Обеспечивает быструю реакцию на отклонение
   - Коэффициент: `Kp` (pid_kp)

2. **Интегральная составляющая (I)**
   - Учитывает накопленную ошибку за время
   - Устраняет статическую ошибку
   - Коэффициент: `Ki` (pid_ki)
   - Состояние: `pid_integral` (сохраняется в БД)

3. **Дифференциальная составляющая (D)**
   - Учитывает скорость изменения ошибки
   - Предотвращает перерегулирование
   - Коэффициент: `Kd` (pid_kd)
   - Состояние: `pid_last_error` (сохраняется в БД)

**Параметры PID регулятора:**
- `trigger_field` — поле входа (field1-8), текущее значение процесса
- `pid_setpoint` — заданное значение (setpoint), к которому стремимся
- `pid_kp` — пропорциональный коэффициент (Kp)
- `pid_ki` — интегральный коэффициент (Ki)
- `pid_kd` — дифференциальный коэффициент (Kd)
- `pid_output_min` — минимальное значение выхода (ограничение)
- `pid_output_max` — максимальное значение выхода (ограничение)
- `target_field` — целевое поле (field1-8), куда записывается результат

**Состояние PID регулятора:**
- `pid_integral` — накопленная интегральная ошибка (сохраняется в БД)
- `pid_last_error` — предыдущая ошибка (сохраняется в БД)

**Алгоритм работы:**

```python
# 1. Получить текущее значение процесса
current_value = feed.trigger_field

# 2. Вычислить ошибку
error = pid_setpoint - current_value

# 3. Пропорциональная составляющая
P = pid_kp * error

# 4. Интегральная составляющая (накопление)
pid_integral += error
I = pid_ki * pid_integral

# 5. Дифференциальная составляющая
D = pid_kd * (error - pid_last_error)

# 6. Вычислить выход
output = P + I + D

# 7. Ограничить выход
output = max(pid_output_min, min(pid_output_max, output))

# 8. Записать в целевое поле
feed.target_field = output

# 9. Сохранить состояние для следующей итерации
pid_last_error = error
```

**Примеры использования:**

**Пример 1: Поддержание температуры с PID регулятором**
```json
{
  "name": "PID контроль температуры",
  "rule_type": "pid",
  "trigger_field": "field1",
  "pid_setpoint": 22.0,
  "pid_kp": 2.0,
  "pid_ki": 0.1,
  "pid_kd": 0.5,
  "pid_output_min": 0.0,
  "pid_output_max": 100.0,
  "target_field": "field2",
  "priority": 1
}
```
*Поддерживает температуру (field1) на уровне 22°C, регулируя мощность обогревателя (field2) от 0% до 100%*

**Пример 2: PID регулятор уровня жидкости**
```json
{
  "name": "PID контроль уровня",
  "rule_type": "pid",
  "trigger_field": "field3",
  "pid_setpoint": 50.0,
  "pid_kp": 1.5,
  "pid_ki": 0.05,
  "pid_kd": 0.3,
  "pid_output_min": 0.0,
  "pid_output_max": 80.0,
  "target_field": "field4",
  "priority": 1
}
```
*Поддерживает уровень жидкости (field3) на 50%, регулируя скорость насоса (field4)*

**Настройка коэффициентов PID:**

**Метод Ziegler-Nichols (примерные значения):**

1. **Только P (Ki=0, Kd=0)**
   - Увеличивать Kp до появления колебаний
   - Ku = критический Kp, Tu = период колебаний

2. **Классический PID:**
   - Kp = 0.6 × Ku
   - Ki = 1.2 × Ku / Tu
   - Kd = 3 × Ku × Tu / 40

3. **Консервативный подход:**
   - Начать с малых значений
   - Kp = 1.0-2.0
   - Ki = 0.01-0.1
   - Kd = 0.1-0.5
   - Настраивать по результатам

**Особенности реализации:**

1. **Сохранение состояния**: Интегральная и дифференциальная составляющие сохраняются в БД между итерациями
2. **Ограничение выхода**: Выход ограничивается между `pid_output_min` и `pid_output_max`
3. **Округление**: Результат округляется до 2 знаков после запятой
4. **Обработка ошибок**: При отсутствии данных правило пропускается

---

### 3. Математические выражения (math)

**Назначение**: Вычисление значений полей по математическим формулам.

**Принцип работы:**
1. Парсится выражение вида `field2 = field1 * 2 + 10`
2. Подставляются значения полей из текущей записи
3. Вычисляется результат
4. Записывается в целевое поле

**Параметры:**
- `expression` — математическое выражение (string)
- `target_field` — целевое поле определяется из выражения

**Формат выражения:**
```
target_field = математическое_выражение
```

**Поддерживаемые операции:**
- Арифметические: `+`, `-`, `*`, `/`, `**` (степень), `^` (степень)
- Функции:
  - `sqrt(x)` — квадратный корень
  - `abs(x)` — модуль
  - `pow(x, y)` — степень
  - `min(x, y, ...)` — минимум
  - `max(x, y, ...)` — максимум
  - `round(x)` — округление

**Примеры использования:**

**Пример 1: Конвертация температуры**
```json
{
  "name": "Конвертация в Фаренгейты",
  "rule_type": "math",
  "expression": "field2 = field1 * 1.8 + 32",
  "priority": 1
}
```
*Конвертирует температуру из Цельсия (field1) в Фаренгейты (field2)*

**Пример 2: Вычисление среднего значения**
```json
{
  "name": "Среднее значение",
  "rule_type": "math",
  "expression": "field8 = (field1 + field2 + field3) / 3",
  "priority": 2
}
```

**Пример 3: Вычисление с функциями**
```json
{
  "name": "Нормализация значения",
  "rule_type": "math",
  "expression": "field4 = sqrt(field1 * field1 + field2 * field2)",
  "priority": 1
}
```

**Безопасность:**
- Используется безопасная оценка выражений
- Разрешены только математические операции
- Запрещены вызовы системных функций
- Валидация символов перед выполнением

---

## Приоритет правил

**Принцип**: Правила выполняются в порядке приоритета (от меньшего к большему).

**Параметр:** `priority` (Integer, default: 0)

**Пример:**
```json
[
  {
    "name": "Правило 1",
    "priority": 1  // Выполнится первым
  },
  {
    "name": "Правило 2",
    "priority": 5  // Выполнится вторым
  },
  {
    "name": "Правило 3",
    "priority": 10 // Выполнится последним
  }
]
```

**Рекомендации:**
- Используйте приоритеты для контроля порядка выполнения
- Правила с меньшим приоритетом выполняются раньше
- Результаты предыдущих правил доступны следующим

---

## Интеграция с системой

### Точка входа

Автоматизация вызывается при создании новой записи данных через API `/update`:

```python
# В feed_service.py или feeds.py router
feed = create_feed(db, channel, feed_data, auto_commit=False)

# Выполнение правил автоматизации
from app.services.automation_service import automation_engine
feed = automation_engine.execute_rules(channel.id, feed, db)

# Сохранение модифицированной записи
db.commit()
```

### Обработка ошибок

- Если правило вызывает ошибку, оно пропускается
- Остальные правила продолжают выполняться
- Ошибки логируются в консоль (можно улучшить)

### Производительность

- Правила выполняются синхронно при записи данных
- Для высоконагруженных систем рекомендуется:
  - Минимизировать количество правил
  - Оптимизировать математические выражения
  - Использовать индексы БД для быстрого поиска правил

---

## API для работы с автоматизацией

### Создание правила

**POST** `/api/channels/{channel_id}/automation`

**Тело запроса (PID регулятор):**
```json
{
  "name": "PID контроль температуры",
  "rule_type": "pid",
  "priority": 1,
  "trigger_field": "field1",
  "pid_setpoint": 22.0,
  "pid_kp": 2.0,
  "pid_ki": 0.1,
  "pid_kd": 0.5,
  "pid_output_min": 0.0,
  "pid_output_max": 100.0,
  "target_field": "field2",
  "is_active": true
}
```

**Тело запроса (Пороговое правило):**
```json
{
  "name": "Включение обогрева",
  "rule_type": "condition",
  "priority": 1,
  "trigger_field": "field1",
  "condition": "<",
  "threshold_value": 18.0,
  "target_field": "field2",
  "action_type": "set_value",
  "action_value": 100.0,
  "is_active": true
}
```

**Тело запроса (Математическое выражение):**
```json
{
  "name": "Конвертация температуры",
  "rule_type": "math",
  "priority": 1,
  "expression": "field2 = field1 * 1.8 + 32",
  "is_active": true
}
```

### Получение списка правил

**GET** `/api/channels/{channel_id}/automation`

**Ответ:**
```json
[
  {
    "id": 1,
    "name": "PID контроль температуры",
    "rule_type": "pid",
    "priority": 1,
    "trigger_field": "field1",
    "pid_setpoint": 22.0,
    "pid_kp": 2.0,
    "pid_ki": 0.1,
    "pid_kd": 0.5,
    "pid_output_min": 0.0,
    "pid_output_max": 100.0,
    "target_field": "field2",
    "is_active": true,
    "created_at": "2025-12-23T10:00:00Z"
  }
]
```

### Обновление правила

**PUT** `/api/channels/{channel_id}/automation/{rule_id}`

### Удаление правила

**DELETE** `/api/channels/{channel_id}/automation/{rule_id}`

---

## Frontend интерфейс

### Страница автоматизации

**URL:** `/channels/{channel_id}/automation`

**Компоненты:**
- Список правил с возможностью редактирования/удаления
- Форма создания нового правила
- Выбор типа правила (condition/pid/math)
- Поля для настройки параметров в зависимости от типа
- Переключатель активности правила
- Настройка приоритета

**Для PID регулятора:**
- Поле входа (trigger_field)
- Заданное значение (setpoint)
- Коэффициенты Kp, Ki, Kd
- Границы выхода (min/max)
- Целевое поле (target_field)

---

## Примеры использования

### Сценарий 1: Система контроля микроклимата

**Задача:** Поддержание температуры 22°C и влажности 50% в помещении.

**Решение:**

1. **PID регулятор температуры:**
```json
{
  "name": "PID температура",
  "rule_type": "pid",
  "trigger_field": "field1",
  "pid_setpoint": 22.0,
  "pid_kp": 2.0,
  "pid_ki": 0.1,
  "pid_kd": 0.5,
  "target_field": "field3",
  "priority": 1
}
```

2. **PID регулятор влажности:**
```json
{
  "name": "PID влажность",
  "rule_type": "pid",
  "trigger_field": "field2",
  "pid_setpoint": 50.0,
  "pid_kp": 1.5,
  "pid_ki": 0.05,
  "pid_kd": 0.3,
  "target_field": "field4",
  "priority": 2
}
```

### Сценарий 2: Система контроля уровня

**Задача:** Поддержание уровня жидкости на 50% с защитой от переполнения.

**Решение:**

1. **PID регулятор уровня:**
```json
{
  "name": "PID уровень",
  "rule_type": "pid",
  "trigger_field": "field1",
  "pid_setpoint": 50.0,
  "pid_kp": 1.5,
  "pid_ki": 0.05,
  "pid_kd": 0.3,
  "target_field": "field2",
  "priority": 1
}
```

2. **Защита от переполнения:**
```json
{
  "name": "Аварийное отключение",
  "rule_type": "condition",
  "trigger_field": "field1",
  "condition": ">",
  "threshold_value": 90.0,
  "target_field": "field2",
  "action_type": "set_value",
  "action_value": 0.0,
  "priority": 0
}
```

---

## Рекомендации по использованию

### PID регуляторы

1. **Начните с консервативных коэффициентов**
2. **Наблюдайте за поведением системы**
3. **Корректируйте коэффициенты постепенно**
4. **Используйте ограничения выхода для безопасности**
5. **Тестируйте на исторических данных перед применением**

### Пороговые правила

1. **Используйте для простых условий**
2. **Комбинируйте с PID для защиты**
3. **Устанавливайте приоритеты правильно**

### Математические выражения

1. **Используйте для вычислений и преобразований**
2. **Проверяйте выражения на валидность**
3. **Избегайте деления на ноль**

---

## Ограничения и известные проблемы

1. **Состояние PID сохраняется в БД** — может быть узким местом при высокой нагрузке
2. **Синхронное выполнение** — правила выполняются при записи данных, что может замедлить ответ
3. **Обработка ошибок** — ошибки логируются, но не сохраняются в БД
4. **Валидация выражений** — базовая валидация, можно улучшить

---

## Будущие улучшения

1. **Асинхронное выполнение правил** — через очередь задач
2. **Расширенная валидация** — более строгая проверка выражений
3. **Логирование выполнения** — сохранение истории выполнения правил
4. **Визуализация работы PID** — графики ошибки и выхода
5. **Автонастройка PID** — автоматический подбор коэффициентов
6. **Поддержка каскадных PID** — несколько регуляторов в цепочке

---

## Заключение

Модуль автоматизации предоставляет мощные инструменты для автоматической обработки данных IoT устройств. PID регуляторы позволяют реализовать точное управление процессами, пороговые правила — простую логику, математические выражения — вычисления и преобразования данных.

Система легко расширяется и может быть адаптирована под различные задачи автоматизации.

