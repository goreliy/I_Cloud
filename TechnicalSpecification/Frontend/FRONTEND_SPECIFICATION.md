# Техническое задание: Frontend (Веб-интерфейс)

## Общая информация

Frontend системы IBolid Cloud представляет собой серверный веб-интерфейс на базе Jinja2 шаблонов, Bootstrap 5 и Chart.js для визуализации данных. Интерфейс предоставляет полный функционал управления каналами, просмотра данных, настройки виджетов и автоматизации.

## Технологический стек

- **Шаблонизатор**: Jinja2 3.1.2
- **CSS Framework**: Bootstrap 5.3.0
- **Иконки**: Bootstrap Icons 1.11.0
- **Графики**: Chart.js 4.4.0
- **Zoom для графиков**: chartjs-plugin-zoom 2.0.1
- **Жесты**: Hammer.js 2.0.8
- **JavaScript**: Vanilla JS (ES6+)

## Структура страниц

### 1. Базовая страница (`base.html`)

**Назначение**: Базовый шаблон для всех страниц.

**Компоненты:**
- Навигационная панель (Navbar)
- Контейнер контента
- Футер с информацией о системе

**Навигация:**
- Логотип и название системы
- Ссылка "Каналы"
- Ссылка "API Документация"
- Меню пользователя (если авторизован):
  - Профиль пользователя
  - Настройки
  - Выход
- Кнопки "Войти" / "Регистрация" (если не авторизован)
- Ссылка "Админ панель" (для администраторов)

**Блоки для переопределения:**
- `{% block title %}` — заголовок страницы
- `{% block extra_head %}` — дополнительные CSS/JS в `<head>`
- `{% block content %}` — основной контент страницы
- `{% block extra_scripts %}` — дополнительные JS скрипты

---

### 2. Главная страница (`index.html`)

**URL**: `/`

**Назначение**: Приветственная страница с информацией о системе.

**Содержимое:**
- Описание системы
- Основные возможности
- Ссылки на документацию
- Кнопка "Начать работу"

---

### 3. Страница списка каналов (`channels.html`)

**URL**: `/channels`

**Назначение**: Отображение списка всех доступных каналов.

**Функционал:**
- Карточки каналов с информацией:
  - Название канала
  - Описание
  - Изображение канала (если есть)
  - Количество записей
  - Дата создания
  - Владелец (если есть)
- Кнопка "Создать канал" (если авторизован)
- Фильтрация по публичным/приватным каналам
- Поиск по названию канала

**Действия:**
- Переход к детальной странице канала
- Создание нового канала
- Редактирование канала (для владельца)
- Удаление канала (для владельца)

---

### 4. Страница детального просмотра канала (`channel_detail.html`)

**URL**: `/channels/{channel_id}`

**Назначение**: Отображение детальной информации о канале и визуализация данных.

**Структура страницы:**

#### 4.1. Заголовок
- Название канала
- Кнопки действий:
  - "Автоматизация"
  - "Виджеты"
  - "Настройки"
  - "Изменить"

#### 4.2. Изображение канала
- Отображение изображения канала (если загружено)

#### 4.3. Информация о канале
- Описание
- ID канала
- Часовой пояс
- Дата создания
- Количество записей

#### 4.4. Графики данных (для каждого видимого поля)
Для каждого поля (field1-8), если оно видимо:

**Заголовок графика:**
- Название поля (или "Поле N")
- Кнопки выбора периода:
  - 1ч, 6ч, 24ч, 7д, Все
  - Кастомный период (модальное окно)
- Переключатель авто-обновления (10 сек)
- Кнопки управления:
  - Настройки оси Y
  - Сброс масштаба
  - Скачать PNG

**График:**
- Canvas элемент для Chart.js
- Высота: 300px
- Интерактивность:
  - Zoom (колесико мыши, жесты)
  - Pan (перетаскивание)
  - Tooltip при наведении
  - Легенда

**Функционал графиков:**
- Автоматическое обновление данных каждые 10 секунд
- Загрузка данных за выбранный период
- Настройка диапазона оси Y (мин/макс)
- Экспорт графика в PNG
- Сброс масштаба к исходному виду

#### 4.5. Пользовательские виджеты
- Отображение SVG виджетов
- Отображение HTML виджетов с CSS/JS
- Автоматическое обновление данных виджетов
- Привязка данных к элементам виджетов

#### 4.6. Последние записи
- Таблица с последними записями данных
- Отображение всех полей
- Геолокация (если есть)
- Статус

**JavaScript функции:**
- `loadChartData(fieldIndex, period)` — загрузка данных графика
- `loadChartPeriod(fieldIndex, period)` — изменение периода
- `toggleAutoScroll(fieldIndex)` — включение/выключение авто-обновления
- `resetChartZoom(fieldIndex)` — сброс масштаба
- `showYAxisSettings(fieldIndex)` — настройки оси Y
- `downloadChart(fieldIndex)` — экспорт графика
- `showCustomPeriodModal(fieldIndex)` — выбор кастомного периода
- `updateWidgets()` — обновление виджетов

---

### 5. Страница создания/редактирования канала (`channel_form.html`)

**URL**: `/channels/create` или `/channels/{channel_id}/edit`

**Назначение**: Форма создания или редактирования канала.

**Поля формы:**
- Название канала (обязательное)
- Описание (текстовое поле)
- Публичный канал (чекбокс)
- Часовой пояс (выпадающий список)
- Названия полей (field1-8):
  - Поле 1: [текстовое поле]
  - Поле 2: [текстовое поле]
  - ...
  - Поле 8: [текстовое поле]
- Видимость полей (чекбоксы для каждого поля)

**Валидация:**
- Название обязательно
- Часовой пояс должен быть валидным

**Действия:**
- Сохранение канала
- Отмена (возврат к списку каналов)

---

### 6. Страница настроек канала (`channel_settings.html`)

**URL**: `/channels/{channel_id}/settings`

**Назначение**: Расширенные настройки канала.

**Разделы:**

#### 6.1. Внешний вид
- Загрузка изображения канала (800x600px, автоматический resize)
- Загрузка фонового изображения (1920x1080px, автоматический resize)
- Выбор цветовой схемы:
  - Light
  - Dark
  - Blue
  - Green
  - Custom
- Кастомный CSS (текстовое поле с подсветкой синтаксиса)

#### 6.2. Видимость полей
- Чекбоксы для каждого поля (field1-8)
- Предпросмотр видимости

#### 6.3. API ключи
- Список существующих API ключей
- Кнопка "Создать новый ключ"
- Удаление ключей

**Функционал:**
- Предпросмотр изменений
- Сохранение настроек
- Отмена изменений

---

### 7. Страница управления виджетами (`channel_widgets.html`)

**URL**: `/channels/{channel_id}/widgets`

**Назначение**: Управление пользовательскими виджетами канала.

**Структура:**

#### 7.1. Список виджетов
- Карточки существующих виджетов:
  - Название
  - Тип (SVG/HTML)
  - Размеры
  - Предпросмотр
  - Кнопки: "Редактировать", "Удалить", "История версий"

#### 7.2. Создание нового виджета

**Форма создания:**

**Основные параметры:**
- Название виджета (обязательное)
- Тип виджета:
  - SVG (с загрузкой файла)
  - HTML (с кодом)
- Размеры:
  - Ширина (в колонках Bootstrap, 1-12)
  - Высота (в пикселях)

**Для SVG виджетов:**
- Загрузка SVG файла
- Выбор шаблона (thermometer, gauge, level, pressure_gauge)
- Привязки данных (bindings):
  - Элемент SVG (ID элемента)
  - Поле данных (field1-8)
  - Формат отображения (например, "{value}°C")
  - Свойство элемента (textContent, transform, fill, stroke и т.д.)
- Добавление/удаление привязок

**Для HTML виджетов:**
- HTML код (текстовое поле)
- CSS код (текстовое поле)
- JavaScript код (текстовое поле)

**AI генерация:**
- Выбор AI сервиса
- Промпт для генерации
- Кнопка "Сгенерировать"
- Предпросмотр результата
- Сохранение виджета

**Функционал:**
- Предпросмотр виджета в реальном времени
- Тестирование привязок данных
- Сохранение виджета
- Версионирование (автоматическое создание версии при изменении)

---

### 8. Страница редактирования виджета (`widget_edit.html`)

**URL**: `/channels/{channel_id}/widgets/{widget_id}/edit`

**Назначение**: Редактирование существующего виджета.

**Функционал:**
- Аналогичен странице создания виджета
- Отображение текущих значений
- История версий виджета
- Возможность отката к предыдущей версии

---

### 9. Страница автоматизации (`channel_automation.html`)

**URL**: `/channels/{channel_id}/automation`

**Назначение**: Управление правилами автоматизации канала.

**Структура:**

#### 9.1. Список правил
- Таблица с правилами:
  - Название
  - Тип правила
  - Приоритет
  - Условие
  - Статус (активно/неактивно)
  - Действия: "Редактировать", "Удалить"

#### 9.2. Создание/редактирование правила

**Форма:**

**Основные параметры:**
- Название правила (обязательное)
- Тип правила:
  - Пороговое значение (threshold)
  - PID контроллер (pid)
  - Выражение (expression)
- Приоритет (1-100, меньше = выше приоритет)
- Активно/неактивно

**Для порогового правила:**
- Поле триггера (field1-8)
- Условие: >, <, >=, <=, ==, !=
- Пороговое значение
- Целевое поле (field1-8)
- Тип действия:
  - Установить значение
  - Увеличить на значение
  - Уменьшить на значение
- Значение действия

**Для PID контроллера:**
- Поле входа (field1-8)
- Заданное значение (setpoint)
- Коэффициенты: Kp, Ki, Kd
- Минимальный выход
- Максимальный выход
- Целевое поле (field1-8)

**Для выражения:**
- Выражение (например, "field1 * 1.8 + 32")
- Целевое поле (field1-8)

**Функционал:**
- Валидация выражений
- Тестирование правил
- Сохранение правила
- Активация/деактивация правила

---

### 10. Страница входа (`login.html`)

**URL**: `/login`

**Назначение**: Авторизация пользователя.

**Форма:**
- Email (обязательное)
- Пароль (обязательное)
- Чекбокс "Запомнить меня"
- Кнопка "Войти"
- Ссылка "Забыли пароль?"
- Ссылка "Регистрация"

**Валидация:**
- Email должен быть валидным
- Пароль обязателен
- Отображение ошибок авторизации

**После успешного входа:**
- Редирект на страницу, указанную в параметре `next`
- Или редирект на главную страницу

---

### 11. Страница регистрации (`register.html`)

**URL**: `/register`

**Назначение**: Регистрация нового пользователя.

**Форма:**
- Email (обязательное)
- Пароль (обязательное, минимум 8 символов)
- Подтверждение пароля (обязательное)
- Кнопка "Зарегистрироваться"
- Ссылка "Уже есть аккаунт? Войти"

**Валидация:**
- Email должен быть уникальным
- Пароли должны совпадать
- Пароль должен быть достаточно сложным
- Отображение ошибок валидации

---

### 12. Страница настроек пользователя (`settings.html`)

**URL**: `/settings`

**Назначение**: Настройки профиля пользователя.

**Разделы:**

#### 12.1. Профиль
- Аватар (загрузка, автоматический resize до 300x300px)
- Отображаемое имя
- Биография
- Сайт
- Местоположение
- Сохранение изменений

#### 12.2. Безопасность
- Смена пароля:
  - Текущий пароль
  - Новый пароль
  - Подтверждение нового пароля
- Валидация пароля

---

### 13. Админ-панель (`admin/`)

#### 13.1. Dashboard (`admin/dashboard.html`)

**URL**: `/admin`

**Назначение**: Главная страница админ-панели с метриками системы.

**Метрики:**
- Общее количество пользователей
- Активные пользователи
- Общее количество каналов
- Публичные каналы
- Общее количество записей данных
- Записи за последние 24 часа
- API запросы за последние 24 часа
- Среднее время ответа

**Системные метрики (real-time):**
- CPU использование (%)
- Использование памяти (%)
- Использование диска (%)
- Графики метрик за последний час

**Автообновление:**
- Метрики обновляются каждые 5 секунд
- Графики обновляются каждые 10 секунд

#### 13.2. Управление пользователями (`admin/users.html`)

**URL**: `/admin/users`

**Назначение**: Управление пользователями системы.

**Функционал:**
- Таблица пользователей:
  - Email
  - Имя (из профиля)
  - Количество каналов
  - Дата регистрации
  - Последний вход
  - Статус (активен/неактивен)
  - Права администратора
- Сортировка по колонкам
- Поиск по email
- Фильтрация:
  - Все пользователи
  - Только активные
  - Только администраторы
- Действия:
  - Активация/деактивация пользователя
  - Назначение/снятие прав администратора
  - Удаление пользователя

#### 13.3. Управление каналами (`admin/channels.html`)

**URL**: `/admin/channels`

**Назначение**: Управление всеми каналами системы.

**Функционал:**
- Таблица каналов:
  - ID
  - Название
  - Владелец
  - Публичный/приватный
  - Количество записей
  - Дата создания
- Сортировка
- Поиск
- Фильтрация по публичным/приватным
- Действия:
  - Просмотр канала
  - Редактирование
  - Удаление

#### 13.4. Логи API запросов (`admin/requests.html`)

**URL**: `/admin/requests`

**Назначение**: Просмотр логов всех API запросов.

**Функционал:**
- Таблица запросов:
  - Время запроса
  - Метод (GET/POST/PUT/DELETE)
  - URL
  - Код ответа
  - Время ответа (мс)
  - IP адрес
  - User-Agent
- Фильтрация:
  - По методу
  - По коду ответа
  - По дате (начало/конец)
- Сортировка
- Пагинация
- Экспорт логов

#### 13.5. Настройки архивации (`admin/archive.html`)

**URL**: `/admin/archive`

**Назначение**: Настройка системы архивации данных.

**Функционал:**
- Включение/выключение архивации
- Выбор backend (SQLite/PostgreSQL)
- Настройка параметров:
  - Путь к файлу SQLite (для SQLite)
  - Параметры подключения к PostgreSQL
  - Период хранения (дни)
  - Интервал архивации (секунды)
  - Стратегия (копировать и удалить / только удалить)
- Кнопка "Запустить архивацию сейчас"
- Статус последней архивации
- Статистика архивированных данных

---

## Компоненты и виджеты

### Графики Chart.js

**Конфигурация:**
- Тип: Line chart
- Интерактивность: zoom, pan
- Анимации: плавные переходы
- Легенда: отображается
- Tooltip: при наведении

**Настройки:**
- Масштабирование по оси Y (настраиваемое)
- Автоматическое масштабирование
- Экспорт в PNG

### SVG виджеты

**Функционал:**
- Загрузка SVG файлов
- Привязка данных к элементам SVG
- Динамическое обновление значений
- Поддержка различных форматов данных

**Привязки:**
- textContent — текст элемента
- transform — трансформации (rotate, translate, scale)
- fill — цвет заливки
- stroke — цвет обводки
- opacity — прозрачность
- И другие атрибуты SVG

### HTML виджеты

**Функционал:**
- Кастомный HTML код
- Кастомный CSS
- Кастомный JavaScript
- Доступ к данным канала через API
- Безопасное выполнение кода

---

## Стилизация

### Цветовые схемы каналов

1. **Light** (по умолчанию)
   - Светлый фон
   - Темный текст
   - Синие акценты

2. **Dark**
   - Темный фон
   - Светлый текст
   - Яркие акценты

3. **Blue**
   - Синяя цветовая схема
   - Голубые оттенки

4. **Green**
   - Зеленая цветовая схема
   - Природные оттенки

5. **Custom**
   - Пользовательский CSS
   - Полная кастомизация

### Адаптивность

- Мобильные устройства (до 576px)
- Планшеты (576px - 992px)
- Десктоп (992px+)

Используется Bootstrap Grid System для адаптивной верстки.

---

## JavaScript API

### Работа с данными канала

```javascript
// Загрузка данных канала
async function loadChannelData(channelId, params) {
  const response = await fetch(`/channels/${channelId}/feeds.json?${new URLSearchParams(params)}`);
  return await response.json();
}

// Обновление виджета
async function updateWidget(widgetId, data) {
  const response = await fetch(`/api/control/widget/${widgetId}/execute`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'update', data })
  });
  return await response.json();
}
```

### Работа с графиками

```javascript
// Создание графика
function createChart(canvasId, data, options) {
  const ctx = document.getElementById(canvasId).getContext('2d');
  return new Chart(ctx, {
    type: 'line',
    data: data,
    options: options
  });
}

// Обновление данных графика
function updateChart(chart, newData) {
  chart.data = newData;
  chart.update();
}
```

---

## Безопасность

### Защита от XSS
- Экранирование всех пользовательских данных в шаблонах
- Использование `|safe` только для доверенного контента
- Валидация HTML кода виджетов

### CSRF защита
- Использование токенов для форм (если требуется)
- Проверка Origin заголовка

### Валидация данных
- Валидация на клиенте (JavaScript)
- Валидация на сервере (Pydantic схемы)

---

## Производительность

### Оптимизации
- Ленивая загрузка графиков (только видимые)
- Кэширование данных на клиенте
- Дебаунсинг для автообновления
- Минификация CSS/JS (в production)

### Автообновление
- Интервал обновления: 10 секунд
- Остановка обновления при неактивной вкладке
- Возможность отключения автообновления

---

## Доступность

- Семантическая HTML разметка
- ARIA атрибуты для интерактивных элементов
- Поддержка клавиатурной навигации
- Контрастность цветов (WCAG AA)

---

## Браузерная поддержка

- Chrome/Edge (последние 2 версии)
- Firefox (последние 2 версии)
- Safari (последние 2 версии)
- Opera (последние 2 версии)

---

## Тестирование

### Ручное тестирование
- Проверка всех форм
- Проверка валидации
- Проверка интерактивности
- Проверка адаптивности

### Автоматическое тестирование
- Unit тесты для JavaScript функций
- E2E тесты для критических сценариев

