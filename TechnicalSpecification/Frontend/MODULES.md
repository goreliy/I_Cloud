# Описание модулей Frontend

## Общая структура

Frontend система построена на серверном рендеринге с использованием Jinja2 шаблонов и клиентского JavaScript для интерактивности:

```
app/
├── templates/       # HTML шаблоны (Jinja2)
│   ├── base.html    # Базовый шаблон
│   ├── admin/       # Админ-панель
│   └── ...          # Остальные страницы
├── static/          # Статические файлы
│   ├── css/         # Стили
│   ├── js/          # JavaScript
│   ├── svg_templates/ # SVG шаблоны виджетов
│   └── uploads/     # Загруженные файлы
└── routers/web.py   # Роутеры веб-страниц
```

---

## 1. Модуль базового шаблона (`templates/base.html`)

### Назначение
Базовый шаблон, от которого наследуются все остальные страницы.

### Компоненты

#### 1.1. HTML структура
- DOCTYPE и мета-теги
- Подключение Bootstrap CSS
- Подключение Bootstrap Icons
- Подключение кастомных стилей
- Блоки для переопределения (`extra_head`, `content`, `extra_scripts`)

#### 1.2. Навигационная панель (Navbar)
**Компоненты:**
- Логотип и название системы
- Основное меню:
  - "Каналы" — ссылка на список каналов
  - "API Документация" — ссылка на Swagger UI
- Меню пользователя (если авторизован):
  - Выпадающее меню с email пользователя
  - "Настройки" — ссылка на настройки профиля
  - "Выход" — выход из системы
- Кнопки авторизации (если не авторизован):
  - "Войти"
  - "Регистрация"
- Ссылка "Админ панель" (только для администраторов)

**Адаптивность:**
- Мобильное меню (hamburger) для маленьких экранов
- Раскрывающееся меню на больших экранах

#### 1.3. Контейнер контента
- Bootstrap container с отступами
- Блок `content` для основного контента страниц

#### 1.4. Футер
- Информация о системе
- Информация о ROOT_PATH (для отладки)
- Copyright

---

## 2. Модуль страниц каналов

### 2.1. Список каналов (`channels.html`)

**Компоненты:**

#### Карточки каналов
- Изображение канала (если есть)
- Название канала
- Описание (обрезанное)
- Метки:
  - Публичный/Приватный
  - Количество записей
  - Дата создания
- Кнопки действий:
  - "Просмотр" — переход к детальной странице
  - "Редактировать" (для владельца)
  - "Удалить" (для владельца)

#### Панель управления
- Кнопка "Создать канал" (если авторизован)
- Фильтры:
  - Все каналы
  - Мои каналы
  - Публичные каналы
- Поиск по названию

**JavaScript функции:**
- Фильтрация каналов
- Поиск по названию
- Подтверждение удаления

---

### 2.2. Детальная страница канала (`channel_detail.html`)

**Компоненты:**

#### Заголовок страницы
- Название канала с иконкой
- Кнопки действий:
  - "Автоматизация" — управление правилами
  - "Виджеты" — управление виджетами
  - "Настройки" — настройки канала
  - "Изменить" — редактирование канала

#### Изображение канала
- Полноразмерное изображение (если загружено)
- Адаптивное отображение

#### Информационная карточка
- Описание канала
- ID канала
- Часовой пояс
- Дата создания
- Количество записей

#### Графики данных (field1-8)
Для каждого видимого поля:

**Заголовок графика:**
- Название поля (или "Поле N")
- Кнопки выбора периода:
  - 1ч, 6ч, 24ч, 7д, Все
  - Кастомный период (модальное окно)
- Переключатель автообновления
- Кнопки управления:
  - Настройки оси Y
  - Сброс масштаба
  - Скачать PNG

**Canvas графика:**
- Chart.js конфигурация:
  - Тип: Line chart
  - Интерактивность: zoom, pan
  - Анимации: плавные переходы
  - Легенда: отображается
  - Tooltip: при наведении

**JavaScript модуль графиков:**
```javascript
// Инициализация графиков
function initCharts() {
  // Создание Chart.js экземпляров для каждого поля
}

// Загрузка данных
async function loadChartData(fieldIndex, period) {
  // Запрос данных через API
  // Обновление графика
}

// Автообновление
function toggleAutoScroll(fieldIndex) {
  // Включение/выключение автообновления каждые 10 секунд
}

// Управление масштабом
function resetChartZoom(fieldIndex) {
  // Сброс масштаба графика
}

// Настройки оси Y
function showYAxisSettings(fieldIndex) {
  // Модальное окно с настройками min/max
}

// Экспорт графика
function downloadChart(fieldIndex) {
  // Экспорт canvas в PNG
}
```

#### Пользовательские виджеты
- Сетка виджетов (Bootstrap grid)
- SVG виджеты:
  - Загрузка SVG через `<object>`
  - Привязка данных к элементам
  - Автоматическое обновление
- HTML виджеты:
  - Встраивание HTML кода
  - Применение CSS
  - Выполнение JavaScript

**JavaScript модуль виджетов:**
```javascript
// Обновление виджетов
async function updateWidgets() {
  // Загрузка последних данных канала
  // Обновление всех виджетов
}

// Обновление SVG виджета
function updateSVGWidget(widgetId, data) {
  // Поиск элементов по ID
  // Применение привязок данных
  // Обновление атрибутов SVG
}

// Обновление HTML виджета
function updateHTMLWidget(widgetId, data) {
  // Выполнение JavaScript кода виджета
  // Передача данных в виджет
}
```

#### Таблица последних записей
- Отображение последних N записей
- Колонки:
  - Время
  - Поле 1-8 (только видимые)
  - Геолокация (если есть)
  - Статус
- Автообновление таблицы

---

### 2.3. Форма создания/редактирования канала (`channel_form.html`)

**Компоненты:**

#### Форма
- Название канала (обязательное)
- Описание (textarea)
- Публичный канал (чекбокс)
- Часовой пояс (select)
- Названия полей (field1-8):
  - Текстовые поля для каждого поля
- Видимость полей (чекбоксы)

#### Валидация
- Клиентская валидация (HTML5 + JavaScript)
- Отображение ошибок
- Подсветка невалидных полей

#### Действия
- Кнопка "Сохранить"
- Кнопка "Отмена"

---

### 2.4. Настройки канала (`channel_settings.html`)

**Компоненты:**

#### Вкладки
- Внешний вид
- Видимость полей
- API ключи

#### Внешний вид
- Загрузка изображения канала:
  - Превью текущего изображения
  - Кнопка загрузки
  - Ограничение размера (800x600px)
- Загрузка фонового изображения:
  - Превью текущего фона
  - Кнопка загрузки
  - Ограничение размера (1920x1080px)
- Выбор цветовой схемы:
  - Radio buttons для выбора схемы
  - Предпросмотр схемы
- Кастомный CSS:
  - Textarea с подсветкой синтаксиса
  - Предпросмотр CSS

#### Видимость полей
- Чекбоксы для каждого поля
- Предпросмотр видимости

#### API ключи
- Таблица существующих ключей:
  - Название ключа
  - Тип (read/write)
  - Сам ключ (скрыт, кнопка показать)
  - Статус (активен/неактивен)
  - Дата создания
  - Действия: удалить
- Форма создания нового ключа:
  - Название ключа
  - Тип ключа (read/write)
  - Кнопка "Создать"

**JavaScript функции:**
- Предпросмотр изменений
- Валидация CSS
- Управление API ключами

---

## 3. Модуль виджетов

### 3.1. Страница управления виджетами (`channel_widgets.html`)

**Компоненты:**

#### Список виджетов
- Карточки виджетов:
  - Название
  - Тип (SVG/HTML)
  - Размеры
  - Предпросмотр
  - Кнопки:
    - "Редактировать"
    - "Удалить"
    - "История версий"

#### Форма создания виджета

**Основные параметры:**
- Название виджета
- Тип виджета (radio buttons):
  - SVG
  - HTML
- Размеры:
  - Ширина (1-12 колонок Bootstrap)
  - Высота (пиксели)

**Для SVG виджетов:**
- Загрузка SVG файла:
  - Drag & drop область
  - Кнопка выбора файла
  - Превью SVG
- Выбор шаблона:
  - Кнопки шаблонов (thermometer, gauge, level, pressure_gauge)
  - Автоматическая загрузка шаблона
- Привязки данных:
  - Динамический список привязок
  - Для каждой привязки:
    - Элемент SVG (ID)
    - Поле данных (field1-8)
    - Формат отображения
    - Свойство элемента
  - Кнопки: "Добавить привязку", "Удалить привязку"

**Для HTML виджетов:**
- HTML код (textarea с подсветкой)
- CSS код (textarea с подсветкой)
- JavaScript код (textarea с подсветкой)
- Предпросмотр виджета

**AI генерация:**
- Выбор AI сервиса (select)
- Промпт для генерации (textarea)
- Кнопка "Сгенерировать"
- Индикатор загрузки
- Предпросмотр результата
- Кнопка "Сохранить виджет"

**JavaScript модуль:**
```javascript
// Загрузка шаблона
async function selectTemplate(template) {
  // Загрузка SVG шаблона
  // Установка в input file
  // Добавление предустановленных привязок
}

// Добавление привязки
function addBinding() {
  // Создание новой строки привязки
}

// Удаление привязки
function removeBinding(id) {
  // Удаление строки привязки
}

// Предпросмотр виджета
function previewWidget() {
  // Отображение виджета с тестовыми данными
}

// Генерация через AI
async function generateWidget() {
  // Отправка запроса к AI API
  // Отображение результата
}
```

---

### 3.2. Редактирование виджета (`widget_edit.html`)

**Компоненты:**
- Аналогично странице создания виджета
- Загрузка текущих значений виджета
- История версий:
  - Таблица версий
  - Комментарии к версиям
  - Кнопка "Восстановить версию"

---

## 4. Модуль автоматизации

### 4.1. Страница автоматизации (`channel_automation.html`)

**Компоненты:**

#### Список правил
- Таблица правил:
  - Название
  - Тип правила
  - Приоритет
  - Условие
  - Статус (активно/неактивно)
  - Действия:
    - "Редактировать"
    - "Удалить"
    - Переключатель активности

#### Форма создания/редактирования правила

**Основные параметры:**
- Название правила
- Тип правила (select):
  - Пороговое значение
  - PID контроллер
  - Выражение
- Приоритет (1-100)
- Активно/неактивно (чекбокс)

**Для порогового правила:**
- Поле триггера (select: field1-8)
- Условие (select: >, <, >=, <=, ==, !=)
- Пороговое значение (number)
- Целевое поле (select: field1-8)
- Тип действия (select):
  - Установить значение
  - Увеличить на значение
  - Уменьшить на значение
- Значение действия (number)

**Для PID контроллера:**
- Поле входа (select: field1-8)
- Заданное значение (number)
- Коэффициенты:
  - Kp (number)
  - Ki (number)
  - Kd (number)
- Границы выхода:
  - Минимум (number)
  - Максимум (number)
- Целевое поле (select: field1-8)

**Для выражения:**
- Выражение (textarea)
- Целевое поле (select: field1-8)
- Подсказка по синтаксису выражений

**JavaScript модуль:**
```javascript
// Валидация выражения
function validateExpression(expr) {
  // Проверка синтаксиса выражения
  // Отображение ошибок
}

// Тестирование правила
async function testRule(ruleData) {
  // Отправка тестовых данных
  // Отображение результата
}
```

---

## 5. Модуль аутентификации

### 5.1. Страница входа (`login.html`)

**Компоненты:**
- Форма входа:
  - Email (input type="email")
  - Пароль (input type="password")
  - Чекбокс "Запомнить меня"
  - Кнопка "Войти"
  - Ссылка "Забыли пароль?"
  - Ссылка "Регистрация"
- Отображение ошибок авторизации
- Редирект после успешного входа

---

### 5.2. Страница регистрации (`register.html`)

**Компоненты:**
- Форма регистрации:
  - Email (input type="email")
  - Пароль (input type="password")
  - Подтверждение пароля (input type="password")
  - Кнопка "Зарегистрироваться"
  - Ссылка "Уже есть аккаунт? Войти"
- Валидация пароля:
  - Минимум 8 символов
  - Индикатор сложности пароля
- Отображение ошибок валидации

---

## 6. Модуль настроек пользователя

### 6.1. Страница настроек (`settings.html`)

**Компоненты:**

#### Вкладки
- Профиль
- Безопасность

#### Профиль
- Аватар:
  - Текущий аватар (превью)
  - Кнопка загрузки
  - Ограничение размера (300x300px)
- Отображаемое имя (input)
- Биография (textarea)
- Сайт (input type="url")
- Местоположение (input)
- Кнопка "Сохранить изменения"

#### Безопасность
- Смена пароля:
  - Текущий пароль (input type="password")
  - Новый пароль (input type="password")
  - Подтверждение нового пароля (input type="password")
  - Индикатор сложности пароля
  - Кнопка "Изменить пароль"
- Валидация пароля

---

## 7. Модуль админ-панели (`templates/admin/`)

### 7.1. Dashboard (`dashboard.html`)

**Компоненты:**

#### Статистика системы
- Карточки метрик:
  - Всего пользователей
  - Активных пользователей
  - Всего каналов
  - Публичных каналов
  - Всего записей
  - Записей за 24ч
  - API запросов за 24ч
  - Среднее время ответа

#### Системные метрики (real-time)
- Графики:
  - CPU использование (%)
  - Использование памяти (%)
  - Использование диска (%)
- Обновление каждые 5 секунд
- Графики за последний час

**JavaScript модуль:**
```javascript
// Загрузка статистики
async function loadStats() {
  // Запрос к /api/admin/stats
  // Обновление карточек метрик
}

// Обновление графиков
function updateSystemCharts(data) {
  // Обновление Chart.js графиков
}

// Автообновление
setInterval(loadStats, 5000);
```

---

### 7.2. Управление пользователями (`users.html`)

**Компоненты:**
- Таблица пользователей:
  - Email
  - Имя
  - Каналов
  - Дата регистрации
  - Последний вход
  - Статус
  - Права администратора
  - Действия
- Сортировка по колонкам
- Поиск по email
- Фильтры:
  - Все пользователи
  - Только активные
  - Только администраторы
- Пагинация
- Модальные окна:
  - Редактирование пользователя
  - Подтверждение удаления

---

### 7.3. Управление каналами (`channels.html`)

**Компоненты:**
- Таблица каналов:
  - ID
  - Название
  - Владелец
  - Публичный/приватный
  - Записей
  - Дата создания
  - Действия
- Сортировка
- Поиск
- Фильтры
- Пагинация

---

### 7.4. Логи API запросов (`requests.html`)

**Компоненты:**
- Таблица запросов:
  - Время
  - Метод
  - URL
  - Код ответа
  - Время ответа (мс)
  - IP адрес
  - User-Agent
- Фильтры:
  - По методу
  - По коду ответа
  - По дате (начало/конец)
- Сортировка
- Пагинация
- Экспорт логов (CSV)

---

### 7.5. Настройки архивации (`archive.html`)

**Компоненты:**
- Форма настроек:
  - Включить архивацию (чекбокс)
  - Backend (radio: SQLite/PostgreSQL)
  - Параметры SQLite:
    - Путь к файлу
  - Параметры PostgreSQL:
    - Хост
    - Порт
    - База данных
    - Пользователь
    - Пароль
    - Схема
    - Использовать SSL (чекбокс)
  - Период хранения (дни)
  - Интервал архивации (секунды)
  - Стратегия (radio: копировать и удалить / только удалить)
- Кнопка "Сохранить настройки"
- Кнопка "Запустить архивацию сейчас"
- Статус последней архивации
- Статистика архивированных данных

---

## 8. Модуль статических файлов (`app/static/`)

### 8.1. CSS (`css/style.css`)

**Содержимое:**
- Кастомные стили для системы
- Переопределения Bootstrap
- Стили для графиков
- Стили для виджетов
- Адаптивные стили

### 8.2. JavaScript (`js/ai_widget.js`)

**Содержимое:**
- Функции для работы с AI виджетами
- Генерация виджетов
- Улучшение промптов

### 8.3. SVG шаблоны (`svg_templates/`)

**Файлы:**
- `thermometer.svg` — термометр
- `gauge.svg` — стрелочный индикатор
- `level.svg` — индикатор уровня
- `pressure_gauge.svg` — манометр

---

## 9. Интеграция компонентов

### Поток данных

```
User Action → JavaScript → API Request → Backend → Database
                                      ↓
                                   Response
                                      ↓
                              Update UI/Graphs/Widgets
```

### Обновление данных

1. **Автообновление графиков:**
   - Интервал: 10 секунд
   - Запрос к `/channels/{id}/feeds.json`
   - Обновление Chart.js графиков

2. **Обновление виджетов:**
   - Загрузка последних данных канала
   - Применение привязок к SVG элементам
   - Выполнение JavaScript кода HTML виджетов

3. **Обработка автоматизации:**
   - Правила обрабатываются на backend при записи данных
   - Результаты автоматически записываются в канал

---

## 10. Производительность и оптимизация

### Оптимизации

1. **Ленивая загрузка:**
   - Графики загружаются только для видимых полей
   - Виджеты загружаются по требованию

2. **Кэширование:**
   - Кэширование данных канала на клиенте
   - Дебаунсинг для автообновления

3. **Минификация:**
   - CSS и JS минифицируются в production
   - Оптимизация изображений

4. **Адаптивность:**
   - Использование Bootstrap Grid
   - Мобильная оптимизация

---

## 11. Безопасность

### Защита от XSS
- Экранирование всех пользовательских данных в шаблонах
- Использование `|safe` только для доверенного контента
- Валидация HTML кода виджетов

### CSRF защита
- Использование токенов для форм (если требуется)
- Проверка Origin заголовка

### Валидация
- Клиентская валидация (HTML5 + JavaScript)
- Серверная валидация (Pydantic схемы)

---

## 12. Расширяемость

### Добавление новых страниц
1. Создать HTML шаблон в `templates/`
2. Наследовать от `base.html`
3. Добавить роутер в `routers/web.py`
4. Добавить необходимый JavaScript

### Добавление новых компонентов
1. Создать переиспользуемый компонент
2. Добавить в базовый шаблон или отдельный файл
3. Использовать в нужных страницах

### Кастомизация стилей
- Переопределение Bootstrap переменных
- Добавление кастомных CSS классов
- Использование кастомного CSS в каналах

