#!/bin/bash
# Скрипт для применения миграций на Linux сервере

set -e  # Остановиться при ошибке

echo "=== Применение миграций базы данных ==="

# Определить путь к проекту (использовать текущую директорию или переданный параметр)
if [ -n "$1" ]; then
    PROJECT_DIR="$1"
    cd "$PROJECT_DIR" || { echo "Ошибка: директория $PROJECT_DIR не найдена"; exit 1; }
else
    # Использовать текущую директорию
    PROJECT_DIR="$(pwd)"
    echo "Используется текущая директория: $PROJECT_DIR"
fi

# Проверить, что мы в правильной директории
if [ ! -f "alembic.ini" ] || [ ! -d "app" ]; then
    echo "Ошибка: не найдены файлы проекта (alembic.ini или директория app)"
    echo "Убедитесь, что вы находитесь в корне проекта"
    exit 1
fi

# Активировать виртуальное окружение
if [ -d "venv" ]; then
    echo "Активация виртуального окружения..."
    source venv/bin/activate
elif [ -d ".venv" ]; then
    echo "Активация виртуального окружения (.venv)..."
    source .venv/bin/activate
else
    echo "Предупреждение: виртуальное окружение не найдено"
fi

# Проверить текущую ревизию
echo ""
echo "Текущая ревизия базы данных:"
alembic current || echo "База данных не инициализирована"

echo ""
echo "История миграций:"
alembic history --verbose | head -20

# Применить миграции
echo ""
echo "Применение миграций до последней версии..."
alembic upgrade head

echo ""
echo "=== Миграции применены успешно ==="
echo ""
echo "Текущая ревизия:"
alembic current

