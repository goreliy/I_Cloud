# 🗺️ СХЕМА ЗАПУСКА СТРЕСС-ТЕСТА

```
┌─────────────────────────────────────────────────────────────────────┐
│                   ЗАПУСК СТРЕСС-ТЕСТА                               │
│                   Выберите один из способов:                         │
└─────────────────────────────────────────────────────────────────────┘
                              │
           ┌──────────────────┼──────────────────┐
           │                  │                  │
           ▼                  ▼                  ▼
    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
    │  СПОСОБ 1   │   │  СПОСОБ 2   │   │  СПОСОБ 3   │
    │Интерактивный│   │  Готовые    │   │   Прямая    │
    │             │   │  сценарии   │   │  команда    │
    └─────────────┘   └─────────────┘   └─────────────┘
           │                  │                  │
           │                  │                  │
           ▼                  ▼                  ▼
    
╔══════════════════════════════════════════════════════════════════════╗
║                        СПОСОБ 1: ИНТЕРАКТИВНЫЙ                       ║
║                        (РЕКОМЕНДУЕТСЯ ДЛЯ НАЧАЛА)                    ║
╚══════════════════════════════════════════════════════════════════════╝

    1. Дважды кликните:           run_stress_test.bat
       Или выполните:             python run_stress_test.py
              │
              ▼
    ┌─────────────────────────────────────────────────────┐
    │ 📋 СКРИПТ ПОКАЗЫВАЕТ ВСЕ КАНАЛЫ:                    │
    │                                                      │
    │   [1] Температурный сенсор ✅                        │
    │       Write API Key: ABCD1234XYZ                     │
    │                                                      │
    │   [2] Датчик влажности ✅                            │
    │       Write API Key: EFGH5678UVW                     │
    └─────────────────────────────────────────────────────┘
              │
              ▼
    ┌─────────────────────────────────────────────────────┐
    │ Введите ID канала для теста: _                      │
    └─────────────────────────────────────────────────────┘
              │
              ▼
    ┌─────────────────────────────────────────────────────┐
    │ Количество воркеров [10]: _                         │
    │ Запросов в секунду (RPS) [100]: _                   │
    │ Длительность в секундах [60]: _                     │
    └─────────────────────────────────────────────────────┘
              │
              ▼
    ┌─────────────────────────────────────────────────────┐
    │ ⚠️  Будет отправлено ~6,000 запросов                │
    │ Продолжить? (yes/no): _                             │
    └─────────────────────────────────────────────────────┘
              │
              ▼
         🚀 ЗАПУСК!

╔══════════════════════════════════════════════════════════════════════╗
║                       СПОСОБ 2: ГОТОВЫЕ СЦЕНАРИИ                     ║
║                      (БЫСТРАЯ ПРОВЕРКА)                              ║
╚══════════════════════════════════════════════════════════════════════╝

    ┌────────────────────────────┐
    │  Дважды кликните файл:     │
    └────────────────────────────┘
              │
              ├──► стресс_тест_легкий.bat
              │    (5 workers, 50 RPS, 30s)
              │    ~1,500 запросов
              │
              ├──► стресс_тест_средний.bat
              │    (10 workers, 100 RPS, 60s)
              │    ~6,000 запросов
              │
              └──► стресс_тест_высокая_нагрузка.bat
                   (50 workers, 1000 RPS, 60s)
                   ~60,000 запросов
              │
              ▼
         🚀 АВТОМАТИЧЕСКИЙ ЗАПУСК!

╔══════════════════════════════════════════════════════════════════════╗
║                       СПОСОБ 3: ПРЯМАЯ КОМАНДА                       ║
║                      (ДЛЯ ОПЫТНЫХ ПОЛЬЗОВАТЕЛЕЙ)                     ║
╚══════════════════════════════════════════════════════════════════════╝

    python tests/stress_test.py \
        --api-key YOUR_WRITE_KEY \
        --channel 1 \
        --workers 10 \
        --rps 100 \
        --duration 60
              │
              ▼
         🚀 ЗАПУСК С ПАРАМЕТРАМИ!

╔══════════════════════════════════════════════════════════════════════╗
║                           ПРОЦЕСС ТЕСТА                              ║
╚══════════════════════════════════════════════════════════════════════╝

    🚀 Запуск теста...
         │
         ▼
    ┌──────────────────────────────────────────────────┐
    │  [15s] Total: 1,543 | Success: 1,540 (99.8%) |  │
    │         Failed: 3 | RPS: 103 | Latency: 42ms    │
    └──────────────────────────────────────────────────┘
         │ (Обновляется каждую секунду)
         ▼
    ┌──────────────────────────────────────────────────┐
    │  [60s] Total: 6,180 | Success: 6,150 (99.5%) |  │
    │         Failed: 30 | RPS: 100 | Latency: 45ms   │
    └──────────────────────────────────────────────────┘
         │
         ▼
    ✅ ТЕСТ ЗАВЕРШЁН!

╔══════════════════════════════════════════════════════════════════════╗
║                          РЕЗУЛЬТАТЫ ТЕСТА                            ║
╚══════════════════════════════════════════════════════════════════════╝

    ┌────────────────────────────────────────────────────┐
    │         STRESS TEST RESULTS                        │
    ├────────────────────────────────────────────────────┤
    │ Total requests:     6,234                          │
    │ Successful:         6,180 (99.1%)                  │
    │ Failed:             54 (0.9%)                      │
    │ Duration:           60.15s                         │
    │                                                    │
    │ Actual RPS:         103.62                         │
    │ Target RPS:         100                            │
    │ Efficiency:         103.6%                         │
    │                                                    │
    │ Latency (ms):                                      │
    │   Average:          45.32ms                        │
    │   Min:              12.45ms                        │
    │   Max:              234.56ms                       │
    │   P95:              89.34ms                        │
    └────────────────────────────────────────────────────┘
         │
         ├──► 📄 stress_test_20251031_143022.json
         │    (Подробные результаты в JSON)
         │
         └──► 💾 База данных обновлена
              (Новые записи в таблице feeds)

╔══════════════════════════════════════════════════════════════════════╗
║                         ПРОВЕРКА РЕЗУЛЬТАТОВ                         ║
╚══════════════════════════════════════════════════════════════════════╝

    ┌────────────────────────────┐
    │  В КОНСОЛИ (сразу)         │
    └────────────────────────────┘
         │
         └──► См. вывод выше ↑

    ┌────────────────────────────┐
    │  В ФАЙЛЕ JSON              │
    └────────────────────────────┘
         │
         └──► stress_test_*.json
              (Полные данные в JSON формате)

    ┌────────────────────────────┐
    │  В БАЗЕ ДАННЫХ             │
    └────────────────────────────┘
         │
         └──► sqlite3 thingspeak.db "SELECT COUNT(*) FROM feeds WHERE channel_id=1"
              sqlite3 thingspeak.db "SELECT * FROM feeds ORDER BY id DESC LIMIT 10"

    ┌────────────────────────────┐
    │  В ВЕБ-ИНТЕРФЕЙСЕ          │
    └────────────────────────────┘
         │
         └──► http://localhost:8000
              Откройте канал → обновите страницу (F5)
              Увидите новые данные на графиках

╔══════════════════════════════════════════════════════════════════════╗
║                         ЧТО ГЕНЕРИРУЕТСЯ                             ║
╚══════════════════════════════════════════════════════════════════════╝

    Каждый запрос создаёт одну запись с 8 полями:
    
    ┌────────────────────────────────────────────────────┐
    │  field1: 45.67  (случайное 0-100)                  │
    │  field2: 89.12  (случайное 0-100)                  │
    │  field3: 23.45  (случайное 0-100)                  │
    │  field4: 67.89  (случайное 0-100)                  │
    │  field5: 12.34  (случайное 0-100)                  │
    │  field6: 56.78  (случайное 0-100)                  │
    │  field7: 90.12  (случайное 0-100)                  │
    │  field8: 34.56  (случайное 0-100)                  │
    └────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════╗
║                         АРХИТЕКТУРА ТЕСТА                            ║
╚══════════════════════════════════════════════════════════════════════╝

    ┌──────────────────────────────────────────────────┐
    │            СТРЕСС-ТЕСТ (asyncio)                 │
    └──────────────────────────────────────────────────┘
         │
         ├──► Worker 1 ──┐
         ├──► Worker 2 ──┤
         ├──► Worker 3 ──┤
         ├──► ...        ├──► HTTP POST /update?api_key=...&field1=...
         ├──► Worker N-1 ┤
         └──► Worker N ──┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │   FastAPI Server              │
         │   (localhost:8000)            │
         └───────────────────────────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │   API Endpoint: /update       │
         │   (feeds.py)                  │
         └───────────────────────────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │   Automation Rules            │
         │   (если настроены)            │
         └───────────────────────────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │   SQLite Database             │
         │   (thingspeak.db)             │
         │   Таблица: feeds              │
         └───────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════╗
║                      РЕКОМЕНДУЕМАЯ ПОСЛЕДОВАТЕЛЬНОСТЬ                ║
╚══════════════════════════════════════════════════════════════════════╝

    1️⃣  ПЕРВЫЙ ЗАПУСК (проверка)
         │
         └──► стресс_тест_легкий.bat
              ├── 5 workers
              ├── 50 RPS
              ├── 30 секунд
              └── ~1,500 запросов
         │
         ▼
    ✅ Success rate > 99%?
         │
         ├──► ДА ──────────────────────┐
         │                             │
         └──► НЕТ: Проверьте сервер   │
                   и API ключ          │
                                       │
    2️⃣  ВТОРОЙ ЗАПУСК (обычная нагрузка) ◄────┘
         │
         └──► стресс_тест_средний.bat
              ├── 10 workers
              ├── 100 RPS
              ├── 60 секунд
              └── ~6,000 запросов
         │
         ▼
    ✅ Success rate > 95%?
         │
         ├──► ДА ──────────────────────┐
         │                             │
         └──► НЕТ: Оптимизируйте БД   │
                   или снизьте RPS     │
                                       │
    3️⃣  ТРЕТИЙ ЗАПУСК (стресс-тест) ◄──────────┘
         │
         └──► стресс_тест_высокая_нагрузка.bat
              ├── 50 workers
              ├── 1000 RPS
              ├── 60 секунд
              └── ~60,000 запросов
         │
         ▼
    📊 Анализ результатов
         │
         ├──► Success rate: %
         ├──► Latency: ms
         ├──► Throughput: RPS
         └──► Errors: типы и количество

╔══════════════════════════════════════════════════════════════════════╗
║                        БЫСТРЫЕ КОМАНДЫ                               ║
╚══════════════════════════════════════════════════════════════════════╝

    Получить API ключ:
    ┌────────────────────────────────────────────────────┐
    │ python -c "import sqlite3; [print(f'Ch {c[0]}: {c[1]}') for c in sqlite3.connect('thingspeak.db').execute('SELECT channel_id, key FROM api_keys WHERE type=\"write\"').fetchall()]" │
    └────────────────────────────────────────────────────┘

    Посмотреть количество записей:
    ┌────────────────────────────────────────────────────┐
    │ sqlite3 thingspeak.db "SELECT COUNT(*) FROM feeds WHERE channel_id=1" │
    └────────────────────────────────────────────────────┘

    Последние 5 записей:
    ┌────────────────────────────────────────────────────┐
    │ sqlite3 thingspeak.db "SELECT entry_id, field1, field2 FROM feeds WHERE channel_id=1 ORDER BY id DESC LIMIT 5" │
    └────────────────────────────────────────────────────┘

    Очистить тестовые данные:
    ┌────────────────────────────────────────────────────┐
    │ sqlite3 thingspeak.db "DELETE FROM feeds WHERE channel_id=1; UPDATE channels SET last_entry_id=0 WHERE id=1; VACUUM;" │
    └────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════╗
║                            ⚠️  ВАЖНО ⚠️                               ║
╚══════════════════════════════════════════════════════════════════════╝

    ✅ Сервер ДОЛЖЕН быть запущен: python run.py
    ✅ Начинайте с ЛЕГКОГО теста
    ✅ НЕ запускайте на ПРОДАКШЕНЕ
    ✅ ОЧИЩАЙТЕ данные после теста
    ✅ СЛЕДИТЕ за ресурсами (CPU, RAM, Disk)

╔══════════════════════════════════════════════════════════════════════╗
║                            🎉 ГОТОВО! 🎉                             ║
╚══════════════════════════════════════════════════════════════════════╝

    Выберите способ запуска:
    
    ┌─────────────────────────────────┐
    │ run_stress_test.bat             │  ← САМЫЙ ПРОСТОЙ
    └─────────────────────────────────┘
    
    ┌─────────────────────────────────┐
    │ стресс_тест_легкий.bat          │  ← БЫСТРАЯ ПРОВЕРКА
    └─────────────────────────────────┘
    
    ┌─────────────────────────────────┐
    │ python tests/stress_test.py ... │  ← ПОЛНЫЙ КОНТРОЛЬ
    └─────────────────────────────────┘

    📚 Документация:
    - СТРЕСС_ТЕСТ_ИНСТРУКЦИЯ.md (полное руководство)
    - ⚡ БЫСТРЫЙ_ЗАПУСК_СТРЕСС_ТЕСТА ⚡.md (шпаргалка)
    - ИТОГОВАЯ_СВОДКА.md (все изменения)
```

