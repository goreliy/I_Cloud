# ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û: –†–µ–¥–∞–∫—Ç–æ—Ä –≤–∏–¥–∂–µ—Ç–æ–≤ + –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

## üéâ –ß–¢–û –°–î–ï–õ–ê–ù–û

### 1. –†–µ–¥–∞–∫—Ç–æ—Ä –≤–∏–¥–∂–µ—Ç–æ–≤ ‚úÖ

**–§–∞–π–ª—ã:**
- `app/templates/widget_edit.html` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `app/routers/web.py` - GET/POST routes –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `app/templates/channel_widgets.html` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è, —Ä–∞–∑–º–µ—Ä–æ–≤ –≤–∏–¥–∂–µ—Ç–∞
- ‚úÖ –î–ª—è SVG: –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤—è–∑–æ–∫, –∑–∞–º–µ–Ω–∞ SVG —Ñ–∞–π–ª–∞
- ‚úÖ –î–ª—è HTML: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTML/CSS/JS –∫–æ–¥–∞
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–∏–≤—è–∑–æ–∫ –≤ —Ñ–æ—Ä–º—É
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

### 2. –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ ‚úÖ

**–§–∞–π–ª:** `app/templates/channel_widgets.html`

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- –®–∞–±–ª–æ–Ω–Ω—ã–π HTML –∫–æ–¥ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏-–ø—Ä–∏–º–µ—Ä–∞–º–∏
- –®–∞–±–ª–æ–Ω–Ω—ã–π CSS –∫–æ–¥ —Å–æ —Å—Ç–∏–ª—è–º–∏
- –®–∞–±–ª–æ–Ω–Ω—ã–π JavaScript —Å —Ñ—É–Ω–∫—Ü–∏–µ–π `onDataUpdate(newData)`
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ `window.channelData`
- –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–∞–Ω–∞–ª–∞

**–ü—Ä–∏–º–µ—Ä:**
```javascript
function onDataUpdate(newData) {
    // newData.field1, field2, ... –¥–æ—Å—Ç—É–ø–Ω—ã
    document.getElementById('value-display').textContent = newData.field1 + '¬∞C';
    
    // –ò–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç –ø–æ —É—Å–ª–æ–≤–∏—é
    if (newData.field1 > 30) {
        // –∫—Ä–∞—Å–Ω—ã–π
    }
}
```

---

### 3. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ (Automation Rules) ‚úÖ

#### –ú–æ–¥–µ–ª—å –∏ –ë–î
**–§–∞–π–ª—ã:**
- `app/models/automation_rule.py` - –º–æ–¥–µ–ª—å AutomationRule
- `app/schemas/automation.py` - Pydantic schemas
- `alembic/versions/006_add_automation_rules.py` - –º–∏–≥—Ä–∞—Ü–∏—è –ë–î

**–ü–æ–ª—è –º–æ–¥–µ–ª–∏:**
- –ë–∞–∑–æ–≤—ã–µ: name, rule_type, priority, is_active
- Condition: trigger_field, condition, threshold_value, target_field, action_type, action_value
- PID: pid_setpoint, pid_kp, pid_ki, pid_kd, pid_integral, pid_last_error, pid_output_min, pid_output_max
- Math: expression

#### Automation Engine
**–§–∞–π–ª:** `app/services/automation_service.py`

**–¢–∏–ø—ã –ø—Ä–∞–≤–∏–ª:**

**1. Condition (–£—Å–ª–æ–≤–∏–µ):**
```
IF field1 > 30 THEN field2 = 100
IF field1 < 10 THEN field2 = 0
IF field1 == 25 THEN field2 = field2 + 1
```

**2. PID Controller (–ü–ò–î-—Ä–µ–≥—É–ª—è—Ç–æ—Ä):**
```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç setpoint
# P = Kp * error
# I = Ki * integral
# D = Kd * derivative
output = P + I + D
```

**3. Math Expression (–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞):**
```
field2 = field1 * 2 + 10
field3 = (field1 + field2) / 2
field4 = sqrt(field1^2 + field2^2)
```

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- Whitelist —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—ã—Ä–∞–∂–µ–Ω–∏–π
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
**–§–∞–π–ª:** `app/routers/feeds.py`

Automation rules –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:

```python
# –°–æ–∑–¥–∞—Ç—å feed
feed = feed_service.create_feed(db, channel, feed_data, auto_commit=False)

# –í—ã–ø–æ–ª–Ω–∏—Ç—å automation rules
feed = automation_engine.execute_rules(channel.id, feed, db)

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π feed
db.commit()
```

#### API Endpoints
**–§–∞–π–ª:** `app/routers/automation.py`

- `POST /api/channels/{id}/automation` - —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ
- `GET /api/channels/{id}/automation` - —Å–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª
- `GET /api/channels/{id}/automation/{rule_id}` - –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ
- `PUT /api/channels/{id}/automation/{rule_id}` - –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ
- `DELETE /api/channels/{id}/automation/{rule_id}` - —É–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ

#### UI —Å—Ç—Ä–∞–Ω–∏—Ü–∞
**–§–∞–π–ª:** `app/templates/channel_automation.html`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª —Å –¥–µ—Ç–∞–ª—è–º–∏
- ‚úÖ –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª
- ‚úÖ –°–±—Ä–æ—Å –ü–ò–î-—Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞
- ‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ (3 —Ç–∏–ø–∞)
- ‚úÖ –§–æ—Ä–º—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –ø—Ä–∞–≤–∏–ª–∞
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

---

## üì¶ –ù–û–í–´–ï –§–ê–ô–õ–´ (12)

### –ú–æ–¥–µ–ª–∏ –∏ —Å—Ö–µ–º—ã:
1. `app/models/automation_rule.py`
2. `app/schemas/automation.py`

### –°–µ—Ä–≤–∏—Å—ã:
3. `app/services/automation_service.py`

### –†–æ—É—Ç–µ—Ä—ã:
4. `app/routers/automation.py`

### Templates:
5. `app/templates/widget_edit.html`
6. `app/templates/channel_automation.html`

### –ú–∏–≥—Ä–∞—Ü–∏–∏:
7. `alembic/versions/006_add_automation_rules.py`

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
8. `–†–ï–ê–õ–ò–ó–û–í–ê–ù–û_–í–ò–î–ñ–ï–¢–´_–ò_–ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø.md`

### –û–±–Ω–æ–≤–ª–µ–Ω–æ (10 —Ñ–∞–π–ª–æ–≤):
- app/models/__init__.py
- app/models/channel.py
- app/main.py
- app/routers/web.py
- app/routers/feeds.py
- app/services/feed_service.py
- app/templates/channel_widgets.html
- app/templates/channel_detail.html
- init_db.py
- requirements.txt (+asteval)

---

## üöÄ –ö–ê–ö –ü–†–ò–ú–ï–ù–ò–¢–¨

### 1. –û–±–Ω–æ–≤–∏—Ç—å –ë–î

```bash
fix_db.bat
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
del thingspeak.db
python init_db.py
alembic stamp head
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
pip install asteval==0.9.31
```

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å

```bash
python run.py
```

---

## üéØ –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨

### –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–∂–µ—Ç:

1. –û—Ç–∫—Ä–æ–π—Ç–µ `/channels/{id}/widgets`
2. –ù–∞–∂–º–∏—Ç–µ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" –Ω–∞ –≤–∏–¥–∂–µ—Ç–µ
3. –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ä–∞–∑–º–µ—Ä—ã, –ø—Ä–∏–≤—è–∑–∫–∏
4. –î–ª—è SVG: –∑–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤—ã–π —Ñ–∞–π–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
5. –î–ª—è HTML: –∏–∑–º–µ–Ω–∏—Ç–µ –∫–æ–¥
6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

### –°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏:

1. –û—Ç–∫—Ä–æ–π—Ç–µ `/channels/{id}/automation`
2. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ"
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø:
   - **–£—Å–ª–æ–≤–∏–µ** - IF field1 > 30 THEN field2 = 100
   - **–ü–ò–î** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
   - **Math** - –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
5. –°–æ–∑–¥–∞–π—Ç–µ

–ü—Ä–∞–≤–∏–ª–æ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö!

---

## üí° –ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø

### –ü—Ä–∏–º–µ—Ä 1: –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä–µ–≤–µ

```
–¢–∏–ø: Condition
IF field1 > 30
THEN field2 = 100

–†–µ–∑—É–ª—å—Ç–∞—Ç: –ü—Ä–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ >30¬∞C –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –Ω–∞ –ø–æ–ª–Ω—É—é
```

### –ü—Ä–∏–º–µ—Ä 2: –¢–µ—Ä–º–æ—Å—Ç–∞—Ç (–ü–ò–î)

```
–¢–∏–ø: PID
–í—Ö–æ–¥: field1 (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–∞—Ç—á–∏–∫–∞)
–í—ã—Ö–æ–¥: field2 (–º–æ—â–Ω–æ—Å—Ç—å –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è)
Setpoint: 25.0
Kp: 2.0, Ki: 0.5, Kd: 0.1

–†–µ–∑—É–ª—å—Ç–∞—Ç: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 25¬∞C
```

### –ü—Ä–∏–º–µ—Ä 3: –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

```
–¢–∏–ø: Math
Expression: field3 = (field1 + field2) / 2

–†–µ–∑—É–ª—å—Ç–∞—Ç: field3 –≤—Å–µ–≥–¥–∞ —Ä–∞–≤–Ω–æ —Å—Ä–µ–¥–Ω–µ–º—É field1 –∏ field2
```

### –ü—Ä–∏–º–µ—Ä 4: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã

```
–¢–∏–ø: Math
Expression: field4 = field1 * 1.8 + 32

–†–µ–∑—É–ª—å—Ç–∞—Ç: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Celsius ‚Üí Fahrenheit
```

### –ü—Ä–∏–º–µ—Ä 5: –ö–æ–Ω—Ç—Ä–æ–ª—å —É—Ä–æ–≤–Ω—è

```
–ü—Ä–∞–≤–∏–ª–æ 1 (PID):
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å field1 (—É—Ä–æ–≤–µ–Ω—å) = 50%
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ field2 (–Ω–∞—Å–æ—Å)

–ü—Ä–∞–≤–∏–ª–æ 2 (Condition):
- IF field1 > 90 THEN field3 = 1 (—Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è)

–ü—Ä–∞–≤–∏–ª–æ 3 (Condition):
- IF field1 < 10 THEN field3 = 1 (–Ω–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å)
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê

**–°–æ–∑–¥–∞–Ω–æ:**
- –§–∞–π–ª–æ–≤: 8 –Ω–æ–≤—ã—Ö
- –û–±–Ω–æ–≤–ª–µ–Ω–æ: 10 —Ñ–∞–π–ª–æ–≤
- –°—Ç—Ä–æ–∫ –∫–æ–¥–∞: ~3000+
- –ú–∏–≥—Ä–∞—Ü–∏–π: 1 (006)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –†–µ–¥–∞–∫—Ç–æ—Ä –≤–∏–¥–∂–µ—Ç–æ–≤
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –≤ HTML/CSS/JS
- ‚úÖ –£—Å–ª–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (IF-THEN)
- ‚úÖ –ü–ò–î-—Ä–µ–≥—É–ª—è—Ç–æ—Ä—ã
- ‚úÖ –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø—Ä–∞–≤–∏–ª
- ‚úÖ –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ
- ‚úÖ –°–±—Ä–æ—Å –ü–ò–î
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

---

## ‚ö° –ì–û–¢–û–í–û!

**–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:**

‚úÖ –†–µ–¥–∞–∫—Ç–æ—Ä –≤–∏–¥–∂–µ—Ç–æ–≤  
‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞  
‚úÖ –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏  
‚úÖ –ü–ò–î-—Ä–µ–≥—É–ª—è—Ç–æ—Ä—ã  
‚úÖ –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è  
‚úÖ UI —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è  
‚úÖ API endpoints  
‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è  

**–ó–ê–ü–£–°–ö–ê–ô–¢–ï –ò –¢–ï–°–¢–ò–†–£–ô–¢–ï! üöÄ**





