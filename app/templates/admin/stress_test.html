{% extends "base.html" %}

{% block title %}Стресс-тест - Админ панель - {{ app_name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="bi bi-lightning-charge"></i> Стресс-тестирование</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Главная</a></li>
                <li class="breadcrumb-item"><a href="/admin">Админ</a></li>
                <li class="breadcrumb-item active">Стресс-тест</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link" href="/admin">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/users">
                    <i class="bi bi-people"></i> Пользователи
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/channels">
                    <i class="bi bi-diagram-3"></i> Каналы
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/requests">
                    <i class="bi bi-activity"></i> API Запросы
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/admin/stress-test">
                    <i class="bi bi-lightning-charge"></i> Стресс-тест
                </a>
            </li>
        </ul>
    </div>
</div>

<div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    <strong>Стресс-тестирование</strong> позволяет проверить производительность сервера и определить максимальную нагрузку.
    Тест отправляет асинхронные POST запросы с рандомными данными на выбранный канал.
</div>

<!-- Конфигурация теста -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-play-circle"></i> Запустить новый тест</h5>
    </div>
    <div class="card-body">
        <form id="stressTestForm">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Целевой канал *</label>
                    <select class="form-select" id="channelId" required>
                        {% for channel in channels %}
                        <option value="{{ channel.id }}">
                            {{ channel.name }} (ID: {{ channel.id }})
                        </option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Канал, на который будут отправляться тестовые данные</small>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Длительность (секунды) *</label>
                    <input type="number" class="form-control" id="duration" 
                           value="60" min="1" max="{{ max_duration }}" required>
                    <small class="text-muted">От 1 до {{ max_duration }} секунд</small>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Количество воркеров (потоков) *</label>
                    <input type="number" class="form-control" id="workers" 
                           value="10" min="1" max="{{ max_workers }}" required>
                    <small class="text-muted">1-{{ max_workers }} параллельных потоков</small>
                </div>
                <div class="col-md-6">
                    <label class="form-label">RPS (запросов в секунду) *</label>
                    <input type="number" class="form-control" id="rps" 
                           value="100" min="1" max="{{ max_rps }}" required>
                    <small class="text-muted">1-{{ max_rps }} запросов/сек</small>
                </div>
            </div>
            
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Внимание!</strong> Высокие значения RPS могут перегрузить сервер и вызвать ошибки.
                <br><strong>Рекомендуется начинать с:</strong> 100 RPS, 10 воркеров, 60 секунд.
                <br><strong>Текущие настройки сервера:</strong> {{ server_workers }} воркеров uvicorn
            </div>
            
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-lg btn-primary" id="startTestBtn">
                    <i class="bi bi-play-circle"></i> Запустить стресс-тест
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Текущий тест -->
<div class="card mb-4" id="currentTestCard" style="display: none;">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-hourglass-split"></i> Тест #<span id="currentTestId"></span> выполняется...
        </h5>
    </div>
    <div class="card-body">
        <div class="row text-center mb-3">
            <div class="col-md-3">
                <h6 class="text-muted">Всего запросов</h6>
                <p class="h3" id="liveTotal">-</p>
            </div>
            <div class="col-md-3">
                <h6 class="text-muted">Успешно</h6>
                <p class="h3 text-success" id="liveSuccess">-</p>
            </div>
            <div class="col-md-3">
                <h6 class="text-muted">Ошибок</h6>
                <p class="h3 text-danger" id="liveFailed">-</p>
            </div>
            <div class="col-md-3">
                <h6 class="text-muted">RPS</h6>
                <p class="h3 text-info" id="liveRps">-</p>
            </div>
        </div>
        
        <div class="progress" style="height: 30px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 id="progressBar" role="progressbar" style="width: 0%">
                <span id="progressText">0%</span>
            </div>
        </div>
        
        <div class="text-center mt-3">
            <small class="text-muted">
                Тест завершится автоматически через <span id="timeRemaining">-</span> секунд
            </small>
        </div>
    </div>
</div>

<!-- История тестов -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clock-history"></i> История тестов</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Канал</th>
                        <th>Воркеры</th>
                        <th>RPS</th>
                        <th>Длительность</th>
                        <th>Запросов</th>
                        <th>Успешно</th>
                        <th>Latency (avg)</th>
                        <th>Статус</th>
                        <th>Дата</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <tr>
                        <td colspan="11" class="text-center text-muted">Загрузка...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentTestId = null;
let statusInterval = null;
let startTime = null;
let duration = 0;

// Загрузить историю при загрузке страницы
loadHistory();

document.getElementById('stressTestForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const config = {
        channel_id: parseInt(document.getElementById('channelId').value),
        workers: parseInt(document.getElementById('workers').value),
        rps: parseInt(document.getElementById('rps').value),
        duration: parseInt(document.getElementById('duration').value)
    };
    
    // Подтверждение
    const totalRequests = config.rps * config.duration;
    if (!confirm(`Запустить стресс-тест?\n\nПараметры:\n  Воркеры: ${config.workers}\n  RPS: ${config.rps}\n  Длительность: ${config.duration}s\n  Всего запросов: ${totalRequests.toLocaleString()}\n\nЭто может нагрузить сервер!`)) {
        return;
    }
    
    // Отправить
    const startTestBtn = document.getElementById('startTestBtn');
    startTestBtn.disabled = true;
    startTestBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Запуск...';
    
    try {
        const response = await fetch('/api/admin/stress-test/start', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify(config)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Ошибка запуска теста');
        }
        
        const data = await response.json();
        currentTestId = data.test_id;
        duration = config.duration;
        startTime = Date.now();
        
        // Показать карточку текущего теста
        document.getElementById('currentTestId').textContent = currentTestId;
        document.getElementById('currentTestCard').style.display = 'block';
        
        // Начать мониторинг
        startMonitoring();
        
    } catch (error) {
        alert('Ошибка: ' + error.message);
        startTestBtn.disabled = false;
        startTestBtn.innerHTML = '<i class="bi bi-play-circle"></i> Запустить стресс-тест';
    }
};

function startMonitoring() {
    statusInterval = setInterval(async () => {
        try {
            const response = await fetch(`/api/admin/stress-test/${currentTestId}`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                updateLiveStats(data);
                
                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(statusInterval);
                    
                    // Показать финальные результаты
                    showFinalResults(data);
                    
                    // Сбросить форму
                    const startTestBtn = document.getElementById('startTestBtn');
                    startTestBtn.disabled = false;
                    startTestBtn.innerHTML = '<i class="bi bi-play-circle"></i> Запустить стресс-тест';
                    
                    // Обновить историю
                    setTimeout(() => loadHistory(), 1000);
                }
            }
        } catch (error) {
            console.error('Error fetching test status:', error);
        }
    }, 1000);
}

function updateLiveStats(data) {
    // Обновить счетчики
    document.getElementById('liveTotal').textContent = (data.total_requests || 0).toLocaleString();
    document.getElementById('liveSuccess').textContent = (data.successful_requests || 0).toLocaleString();
    document.getElementById('liveFailed').textContent = (data.failed_requests || 0).toLocaleString();
    document.getElementById('liveRps').textContent = data.actual_rps ? data.actual_rps.toFixed(1) : '-';
    
    // Обновить progress bar
    const elapsed = (Date.now() - startTime) / 1000;
    const progress = Math.min((elapsed / duration) * 100, 100);
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('progressText').textContent = progress.toFixed(0) + '%';
    
    // Обновить оставшееся время
    const remaining = Math.max(0, duration - elapsed);
    document.getElementById('timeRemaining').textContent = Math.ceil(remaining);
}

function showFinalResults(data) {
    const status = data.status === 'completed' ? 'Завершен' : 'Ошибка';
    const statusClass = data.status === 'completed' ? 'success' : 'danger';
    
    document.getElementById('currentTestCard').querySelector('.card-header').className = `card-header bg-${statusClass} text-white`;
    document.getElementById('currentTestCard').querySelector('.card-header h5').innerHTML = 
        `<i class="bi bi-check-circle"></i> Тест #${data.id} ${status}`;
    
    // Скрыть через 5 секунд
    setTimeout(() => {
        document.getElementById('currentTestCard').style.display = 'none';
    }, 5000);
}

async function loadHistory() {
    try {
        const response = await fetch('/api/admin/stress-test/history/list?limit=20', {
            credentials: 'include'
        });
        
        if (!response.ok) return;
        
        const tests = await response.json();
        const tbody = document.getElementById('historyTableBody');
        
        if (tests.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">Нет данных</td></tr>';
            return;
        }
        
        tbody.innerHTML = tests.map(test => {
            const statusBadge = {
                'completed': '<span class="badge bg-success">Завершен</span>',
                'running': '<span class="badge bg-primary">Выполняется</span>',
                'failed': '<span class="badge bg-danger">Ошибка</span>',
                'pending': '<span class="badge bg-secondary">Ожидание</span>'
            }[test.status] || test.status;
            
            const successRate = test.total_requests > 0 ? 
                ((test.successful_requests / test.total_requests) * 100).toFixed(1) : '-';
            
            return `
                <tr>
                    <td>#${test.id}</td>
                    <td>${test.channel_id}</td>
                    <td>${test.workers}</td>
                    <td>${test.target_rps}</td>
                    <td>${test.duration}s</td>
                    <td>${test.total_requests ? test.total_requests.toLocaleString() : '-'}</td>
                    <td>${test.successful_requests ? test.successful_requests.toLocaleString() + ' (' + successRate + '%)' : '-'}</td>
                    <td>${test.avg_latency_ms ? test.avg_latency_ms.toFixed(2) + 'ms' : '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${new Date(test.started_at).toLocaleString('ru-RU')}</td>
                    <td>
                        ${test.status !== 'running' ? `<button class="btn btn-sm btn-danger" onclick="deleteTest(${test.id})"><i class="bi bi-trash"></i></button>` : ''}
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading history:', error);
    }
}

async function deleteTest(testId) {
    if (!confirm(`Удалить тест #${testId}?`)) return;
    
    try {
        const response = await fetch(`/api/admin/stress-test/${testId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        if (response.ok || response.status === 204) {
            loadHistory();
        } else {
            alert('Ошибка удаления');
        }
    } catch (error) {
        alert('Ошибка: ' + error.message);
    }
}
</script>
{% endblock %}















