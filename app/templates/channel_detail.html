{% extends "base.html" %}

{% block title %}{{ channel.name }} - {{ app_name }}{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-diagram-3"></i> {{ channel.name }}</h1>
    <div>
        <a href="/channels/{{ channel.id }}/automation" class="btn btn-outline-warning">
            <i class="bi bi-lightning-charge"></i> –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
        </a>
        <a href="/channels/{{ channel.id }}/widgets" class="btn btn-outline-info">
            <i class="bi bi-grid-3x3"></i> –í–∏–¥–∂–µ—Ç—ã
        </a>
        <a href="/channels/{{ channel.id }}/settings" class="btn btn-outline-primary">
            <i class="bi bi-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </a>
        <a href="/channels/{{ channel.id }}/edit" class="btn btn-outline-secondary">
            <i class="bi bi-pencil"></i> –ò–∑–º–µ–Ω–∏—Ç—å
        </a>
    </div>
</div>

{% if channel.image_url %}
<div class="card mb-4">
    <img src="{{ channel.image_url }}" class="card-img-top" alt="{{ channel.name }}">
</div>
{% endif %}

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–û –∫–∞–Ω–∞–ª–µ</h5>
            </div>
            <div class="card-body">
                <p>{{ channel.description or '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' }}</p>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">ID –∫–∞–Ω–∞–ª–∞:</small><br>
                        <strong>{{ channel.id }}</strong>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å:</small><br>
                        <strong>{{ channel.timezone }}</strong>
                    </div>
                    <div class="col-6 mt-2">
                        <small class="text-muted">–°–æ–∑–¥–∞–Ω:</small><br>
                        <strong>{{ channel.created_at.strftime('%d.%m.%Y %H:%M') }}</strong>
                    </div>
                    <div class="col-6 mt-2">
                        <small class="text-muted">–ó–∞–ø–∏—Å–µ–π:</small><br>
                        <strong>{{ channel.last_entry_id }}</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        {% for i in range(1, 9) %}
        {% set field_visible_attr = 'field' + i|string + '_visible' %}
        {% if channel[field_visible_attr] is not defined or channel[field_visible_attr] %}
        <div class="card mb-4" id="chart-container-{{ i }}">
            <div class="card-header">
                <div class="row align-items-center mb-2">
                    <div class="col">
                        <h6 class="mb-0">
                            {% set field_label_attr = 'field' + i|string + '_label' %}
                            {{ channel[field_label_attr] if channel[field_label_attr] else '–ü–æ–ª–µ ' + i|string }}
                        </h6>
                    </div>
                    <div class="col-auto">
                        <!-- –í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
                        <div class="btn-group btn-group-sm" role="group" id="period-{{ i }}">
                            <button type="button" class="btn btn-outline-primary" onclick="loadChartPeriod({{ i }}, '1h')">1—á</button>
                            <button type="button" class="btn btn-outline-primary" onclick="loadChartPeriod({{ i }}, '6h')">6—á</button>
                            <button type="button" class="btn btn-outline-primary active" onclick="loadChartPeriod({{ i }}, '24h')">1–¥</button>
                            <button type="button" class="btn btn-outline-primary" onclick="loadChartPeriod({{ i }}, '7d')">7–¥</button>
                            <button type="button" class="btn btn-outline-primary" onclick="loadChartPeriod({{ i }}, 'all')">–í—Å–µ</button>
                            <button type="button" class="btn btn-outline-info" onclick="showCustomPeriodModal({{ i }})" title="–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥">
                                <i class="bi bi-calendar-range"></i> –ü–µ—Ä–∏–æ–¥
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row align-items-center">
                    <div class="col">
                        <!-- –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ -->
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoScroll{{ i }}" onchange="toggleAutoScroll({{ i }})">
                            <label class="form-check-label small" for="autoScroll{{ i }}">
                                <i class="bi bi-arrow-repeat"></i> –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (10 —Å–µ–∫)
                            </label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                        <button class="btn btn-sm btn-outline-secondary" onclick="showYAxisSettings({{ i }})" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å–∏ Y">
                            <i class="bi bi-sliders"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetChartZoom({{ i }})" title="–°–±—Ä–æ—Å –º–∞—Å—à—Ç–∞–±–∞">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="downloadChart({{ i }})" title="–°–∫–∞—á–∞—Ç—å PNG">
                            <i class="bi bi-download"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="chart-field{{ i }}"></canvas>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
        
        <!-- SVG Widgets Section -->
        {% if widgets %}
        <h4 class="mt-4 mb-3"><i class="bi bi-grid-3x3"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –≤–∏–¥–∂–µ—Ç—ã</h4>
        
        <div class="row">
            {% for widget in widgets %}
            <div class="col-md-{{ widget.width }} mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">{{ widget.name }}</h6>
                    </div>
                    <div class="card-body text-center">
                        {% if widget.widget_type == 'svg' and widget.svg_file_url %}
                        <object id="svg-widget-{{ widget.id }}" 
                                data="{{ widget.svg_file_url }}" 
                                type="image/svg+xml" 
                                style="max-width: 100%; height: {{ widget.height }}px;">
                        </object>
                        {% elif widget.widget_type == 'html' %}
                        <!-- Custom HTML widget -->
                        <div id="html-widget-{{ widget.id }}"
                             data-channel-id="{{ channel.id }}"
                             data-widget-id="{{ widget.id }}">
                            {{ widget.html_code | safe }}
                        </div>
                        {% if widget.css_code %}
                        <style>{{ widget.css_code | safe }}</style>
                        {% endif %}
                        {% if widget.js_code %}
                        <script>
(function() {
  const widgetElement = document.getElementById('html-widget-{{ widget.id }}');
  const CHANNEL_ID = {{ channel.id }};
  const WIDGET_ID = {{ widget.id }};
  
  {{ widget.js_code | safe }}
})();
                        </script>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">API –ö–ª—é—á–∏</h5>
            </div>
            <div class="card-body">
                {% if api_keys %}
                    {% for key in api_keys %}
                    <div class="mb-3">
                        <label class="form-label">
                            <strong>
                                {% if key.type == 'write' %}
                                <i class="bi bi-pencil"></i> –ö–ª—é—á –¥–ª—è –∑–∞–ø–∏—Å–∏
                                {% else %}
                                <i class="bi bi-eye"></i> –ö–ª—é—á –¥–ª—è —á—Ç–µ–Ω–∏—è
                                {% endif %}
                            </strong>
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control form-control-sm" value="{{ key.key }}" readonly>
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('{{ key.key }}')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">API –∫–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                {% endif %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/channels/{{ channel.id }}/feeds.json" class="btn btn-outline-primary btn-sm" target="_blank">
                        <i class="bi bi-filetype-json"></i> JSON
                    </a>
                    <a href="/channels/{{ channel.id }}/feeds.xml" class="btn btn-outline-success btn-sm" target="_blank">
                        <i class="bi bi-filetype-xml"></i> XML
                    </a>
                    <a href="/channels/{{ channel.id }}/feeds.csv" class="btn btn-outline-info btn-sm" target="_blank">
                        <i class="bi bi-filetype-csv"></i> CSV
                    </a>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–ü—Ä–∏–º–µ—Ä—ã API –∑–∞–ø—Ä–æ—Å–æ–≤</h5>
            </div>
            <div class="card-body">
                {% if write_key %}
                <h6 class="mt-0">üìù –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö</h6>
                <small><strong>GET –∑–∞–ø—Ä–æ—Å:</strong></small>
                <pre class="bg-light p-2 small"><code>curl "{{ base_url }}/update?api_key={{ write_key }}&field1=25.5&field2=60.2"</code></pre>
                
                <small><strong>POST –∑–∞–ø—Ä–æ—Å:</strong></small>
                <pre class="bg-light p-2 small"><code>curl -X POST "{{ base_url }}/update" \
  -H "Content-Type: application/json" \
  -d '{"api_key":"{{ write_key }}","field1":25.5,"field2":60.2}'</code></pre>
                {% else %}
                <div class="alert alert-warning small mb-2">
                    <small>API –∫–ª—é—á –Ω–∞ –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–∞–Ω–∞–ª–∞.</small>
                </div>
                {% endif %}
                
                {% if read_key %}
                <h6 class="mt-3">üìñ –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h6>
                <small><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</strong></small>
                <pre class="bg-light p-2 small"><code>curl "{{ base_url }}/channels/{{ channel.id }}/feeds/last.json?api_key={{ read_key }}"</code></pre>
                
                <small><strong>–í—Å–µ –¥–∞–Ω–Ω—ã–µ (JSON):</strong></small>
                <pre class="bg-light p-2 small"><code>curl "{{ base_url }}/channels/{{ channel.id }}/feeds.json?api_key={{ read_key }}"</code></pre>
                
                <small><strong>–í—Å–µ –¥–∞–Ω–Ω—ã–µ (CSV):</strong></small>
                <pre class="bg-light p-2 small"><code>curl "{{ base_url }}/channels/{{ channel.id }}/feeds.csv?api_key={{ read_key }}"</code></pre>
                {% else %}
                <div class="alert alert-warning small mb-2 mt-3">
                    <small>API –∫–ª—é—á –Ω–∞ —á—Ç–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–∞–Ω–∞–ª–∞.</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ -->
<div class="modal fade" id="customPeriodModal" tabindex="-1" aria-labelledby="customPeriodModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customPeriodModalLabel">
                    <i class="bi bi-calendar-range"></i> –í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
                <form id="customPeriodForm">
                    <input type="hidden" id="customPeriodFieldNum" value="">
                    <div class="mb-3">
                        <label for="periodStart" class="form-label">–ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞:</label>
                        <input type="datetime-local" class="form-control" id="periodStart" required>
                    </div>
                    <div class="mb-3">
                        <label for="periodEnd" class="form-label">–ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞:</label>
                        <input type="datetime-local" class="form-control" id="periodEnd" required>
                    </div>
                    <div class="alert alert-info small mb-0">
                        <i class="bi bi-info-circle"></i> –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="applyCustomPeriod()">
                    <i class="bi bi-check-circle"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å–∏ Y (min/max) -->
<div class="modal fade" id="yAxisSettingsModal" tabindex="-1" aria-labelledby="yAxisSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="yAxisSettingsModalLabel">
                    <i class="bi bi-sliders"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å–∏ Y
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
                <form id="yAxisSettingsForm">
                    <input type="hidden" id="yAxisFieldNum" value="">
                    <div class="mb-3">
                        <label for="yAxisMin" class="form-label">–ú–∏–Ω–∏–º—É–º (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ):</label>
                        <input type="number" class="form-control" id="yAxisMin" step="any" placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏">
                    </div>
                    <div class="mb-3">
                        <label for="yAxisMax" class="form-label">–ú–∞–∫—Å–∏–º—É–º (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ):</label>
                        <input type="number" class="form-control" id="yAxisMax" step="any" placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏">
                    </div>
                    <div class="alert alert-info small mb-0">
                        <i class="bi bi-info-circle"></i> –û—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª—è –ø—É—Å—Ç—ã–º–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="resetYAxisSettings()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="applyYAxisSettings()">
                    <i class="bi bi-check-circle"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// –•—Ä–∞–Ω–∏–ª–∏—â–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
const charts = {};
const autoScrollIntervals = {};
const channelId = {{ channel.id }};

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ Y-–æ—Å–∏ (min/max)
function getYAxisSettings(fieldNum) {
    const key = `yAxis_${channelId}_${fieldNum}`;
    const saved = localStorage.getItem(key);
    if (saved) {
        try {
            return JSON.parse(saved);
        } catch (e) {
            return { min: null, max: null };
        }
    }
    return { min: null, max: null };
}

function saveYAxisSettings(fieldNum, min, max) {
    const key = `yAxis_${channelId}_${fieldNum}`;
    const settings = {
        min: min !== null && min !== '' ? parseFloat(min) : null,
        max: max !== null && max !== '' ? parseFloat(max) : null
    };
    localStorage.setItem(key, JSON.stringify(settings));
    return settings;
}

function getYAxisScaleOptions(fieldNum) {
    const settings = getYAxisSettings(fieldNum);
    const options = {};
    if (settings.min !== null) {
        options.min = settings.min;
    }
    if (settings.max !== null) {
        options.max = settings.max;
    }
    return options;
}

function applyYAxisToChart(fieldNum) {
    const chart = charts[fieldNum];
    if (!chart) return;
    
    const settings = getYAxisSettings(fieldNum);
    if (settings.min !== null) {
        chart.options.scales.y.min = settings.min;
    } else {
        chart.options.scales.y.min = undefined;
    }
    if (settings.max !== null) {
        chart.options.scales.y.max = settings.max;
    } else {
        chart.options.scales.y.max = undefined;
    }
    chart.update();
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    });
}

// Load and display charts
async function loadCharts() {
    try {
        const response = await fetch('/channels/{{ channel.id }}/feeds.json?results=100');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö
        if (!data || !data.feeds || !Array.isArray(data.feeds)) {
            console.error('Invalid data format:', data);
            document.querySelectorAll('[id^="chart-container-"]').forEach(el => {
                el.innerHTML = '<div class="card-body"><p class="text-muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p></div>';
            });
            return;
        }
        
        const feeds = data.feeds;
        
        if (!feeds || feeds.length === 0) {
            document.querySelectorAll('[id^="chart-container-"]').forEach(el => {
                el.innerHTML = '<div class="card-body"><p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p></div>';
            });
            return;
        }
        
        // Create charts for each field
        for (let i = 1; i <= 8; i++) {
            const fieldName = `field${i}`;
            const fieldData = feeds.filter(f => f[fieldName] !== null).reverse();
            
            if (fieldData.length === 0) {
                document.getElementById(`chart-container-${i}`).style.display = 'none';
                continue;
            }
            
            createChart(i, fieldData);
        }
    } catch (error) {
        console.error('Error loading charts:', error);
    }
}

// Create chart with zoom/pan capabilities
function createChart(fieldNum, fieldData) {
    const fieldName = `field${fieldNum}`;
    const labels = fieldData.map(f => new Date(f.created_at).toLocaleString('ru-RU'));
    const values = fieldData.map(f => f[fieldName]);
    
    const ctx = document.getElementById(`chart-field${fieldNum}`);
    charts[fieldNum] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: `–ü–æ–ª–µ ${fieldNum}`,
                data: values,
                borderColor: `hsl(${fieldNum * 45}, 70%, 50%)`,
                backgroundColor: `hsla(${fieldNum * 45}, 70%, 50%, 0.1)`,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: false
                },
                zoom: {
                    zoom: {
                        wheel: {
                            enabled: true
                        },
                        pinch: {
                            enabled: true
                        },
                        mode: 'x'
                    },
                    pan: {
                        enabled: true,
                        mode: 'x'
                    },
                    limits: {
                        x: {min: 'original', max: 'original'}
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    ticks: {
                        maxTicksLimit: 10
                    }
                },
                y: {
                    display: true,
                    ...getYAxisScaleOptions(fieldNum)
                }
            }
        }
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥
async function loadChartPeriod(fieldNum, period, startDate = null, endDate = null) {
    const now = new Date();
    const params = new URLSearchParams();
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã –≤ ISO —Ñ–æ—Ä–º–∞—Ç –¥–ª—è FastAPI
    // FastAPI –æ–∂–∏–¥–∞–µ—Ç ISO 8601 —Ñ–æ—Ä–º–∞—Ç, –º–æ–∂–Ω–æ —Å –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞–º–∏ –∏–ª–∏ –±–µ–∑
    const formatDate = (date) => {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º toISOString() –∏ —É–±–∏—Ä–∞–µ–º –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        // –§–æ—Ä–º–∞—Ç: YYYY-MM-DDTHH:mm:ssZ
        return date.toISOString().split('.')[0] + 'Z';
    };
    
    if (startDate && endDate) {
        // –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥
        params.append('start', formatDate(startDate));
        params.append('end', formatDate(endDate));
        params.append('results', '8000'); // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–Ω–æ API
    } else if (period !== 'all') {
        const hours = {
            '1h': 1, '6h': 6, '24h': 24, '7d': 168
        };
        const start = new Date(now - hours[period] * 3600000);
        params.append('start', formatDate(start));
        params.append('results', '8000'); // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–Ω–æ API
    } else {
        params.append('results', '1000');
    }
    
    try {
        const url = `/channels/${channelId}/feeds.json?${params.toString()}`;
        console.log('Fetching URL:', url); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
        
        const response = await fetch(url);
        
        if (!response.ok) {
            // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏
            let errorMessage = `HTTP error! status: ${response.status}`;
            try {
                const errorData = await response.json();
                if (errorData.detail) {
                    // detail –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π, –æ–±—ä–µ–∫—Ç–æ–º –∏–ª–∏ –º–∞—Å—Å–∏–≤–æ–º
                    if (typeof errorData.detail === 'string') {
                        errorMessage += ` - ${errorData.detail}`;
                    } else if (Array.isArray(errorData.detail)) {
                        // –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                        const details = errorData.detail.map(err => {
                            if (typeof err === 'string') return err;
                            if (err.msg) return err.msg;
                            if (err.loc && err.msg) return `${err.loc.join('.')}: ${err.msg}`;
                            return JSON.stringify(err);
                        }).join(', ');
                        errorMessage += ` - ${details}`;
                    } else {
                        errorMessage += ` - ${JSON.stringify(errorData.detail)}`;
                    }
                }
            } catch (e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
                console.error('Error parsing error response:', e);
            }
            throw new Error(errorMessage);
        }
        
        const data = await response.json();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö
        if (!data || !data.feeds || !Array.isArray(data.feeds)) {
            console.error('Invalid data format:', data);
            alert('–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
            return;
        }
        
        const fieldName = `field${fieldNum}`;
        const fieldData = data.feeds.filter(f => f[fieldName] !== null).reverse();
        
        if (fieldData.length === 0) {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        if (!charts[fieldNum]) {
            console.error(`Chart for field ${fieldNum} not found`);
            return;
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
        const chart = charts[fieldNum];
        chart.data.labels = fieldData.map(f => new Date(f.created_at).toLocaleString('ru-RU'));
        chart.data.datasets[0].data = fieldData.map(f => f[fieldName]);
        
        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Y-–æ—Å–∏
        applyYAxisToChart(fieldNum);
        
        chart.resetZoom();
        chart.update();
        
        // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥)
        if (!startDate || !endDate) {
            document.querySelectorAll(`#period-${fieldNum} button`).forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target && event.target.tagName === 'BUTTON') {
                event.target.classList.add('active');
            }
        } else {
            // –î–ª—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –≤—ã–¥–µ–ª–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–∏–æ–¥"
            document.querySelectorAll(`#period-${fieldNum} button`).forEach(btn => {
                btn.classList.remove('active');
                // –ù–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É —Å –∏–∫–æ–Ω–∫–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—è (–∫–Ω–æ–ø–∫–∞ "–ü–µ—Ä–∏–æ–¥")
                if (btn.querySelector('i.bi-calendar-range')) {
                    btn.classList.add('active');
                }
            });
        }
        
    } catch (error) {
        console.error('Error loading period data:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
function showCustomPeriodModal(fieldNum) {
    document.getElementById('customPeriodFieldNum').value = fieldNum;
    
    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)
    const end = new Date();
    const start = new Date(end);
    start.setDate(start.getDate() - 7);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è input datetime-local (YYYY-MM-DDTHH:mm)
    const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    };
    
    document.getElementById('periodStart').value = formatDate(start);
    document.getElementById('periodEnd').value = formatDate(end);
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('customPeriodModal'));
    modal.show();
}

// –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥
function applyCustomPeriod() {
    const fieldNum = parseInt(document.getElementById('customPeriodFieldNum').value);
    const startInput = document.getElementById('periodStart').value;
    const endInput = document.getElementById('periodEnd').value;
    
    if (!startInput || !endInput) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞');
        return;
    }
    
    // datetime-local input –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ "YYYY-MM-DDTHH:mm"
    // JavaScript –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç —ç—Ç–æ –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
    const startDate = new Date(startInput);
    const endDate = new Date(endInput);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –¥–∞—Ç
    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
        alert('–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã');
        return;
    }
    
    if (startDate >= endDate) {
        alert('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è');
        return;
    }
    
    console.log('Selected dates:', {
        startInput,
        endInput,
        startDate: startDate.toISOString(),
        endDate: endDate.toISOString()
    });
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = bootstrap.Modal.getInstance(document.getElementById('customPeriodModal'));
    modal.hide();
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
    loadChartPeriod(fieldNum, 'custom', startDate, endDate);
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å–∏ Y
function showYAxisSettings(fieldNum) {
    document.getElementById('yAxisFieldNum').value = fieldNum;
    
    const settings = getYAxisSettings(fieldNum);
    document.getElementById('yAxisMin').value = settings.min !== null ? settings.min : '';
    document.getElementById('yAxisMax').value = settings.max !== null ? settings.max : '';
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('yAxisSettingsModal'));
    modal.show();
}

// –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å–∏ Y
function applyYAxisSettings() {
    const fieldNum = parseInt(document.getElementById('yAxisFieldNum').value);
    const minInput = document.getElementById('yAxisMin').value;
    const maxInput = document.getElementById('yAxisMax').value;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã min –∏ max, min –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–Ω—å—à–µ max
    if (minInput && maxInput) {
        const min = parseFloat(minInput);
        const max = parseFloat(maxInput);
        if (isNaN(min) || isNaN(max)) {
            alert('–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —á–∏—Å–µ–ª');
            return;
        }
        if (min >= max) {
            alert('–ú–∏–Ω–∏–º—É–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–Ω—å—à–µ –º–∞–∫—Å–∏–º—É–º–∞');
            return;
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    saveYAxisSettings(fieldNum, minInput, maxInput);
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = bootstrap.Modal.getInstance(document.getElementById('yAxisSettingsModal'));
    modal.hide();
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –≥—Ä–∞—Ñ–∏–∫—É
    applyYAxisToChart(fieldNum);
}

// –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å–∏ Y
function resetYAxisSettings() {
    const fieldNum = parseInt(document.getElementById('yAxisFieldNum').value);
    
    // –£–¥–∞–ª–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ localStorage
    const key = `yAxis_${channelId}_${fieldNum}`;
    localStorage.removeItem(key);
    
    // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è –≤–≤–æ–¥–∞
    document.getElementById('yAxisMin').value = '';
    document.getElementById('yAxisMax').value = '';
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –≥—Ä–∞—Ñ–∏–∫—É (–≤–µ—Ä–Ω—É—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º)
    applyYAxisToChart(fieldNum);
}

// –°–±—Ä–æ—Å –º–∞—Å—à—Ç–∞–±–∞
function resetChartZoom(fieldNum) {
    if (charts[fieldNum]) {
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Y-–æ—Å–∏ –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º zoom
        const settings = getYAxisSettings(fieldNum);
        charts[fieldNum].resetZoom();
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Y-–æ—Å–∏ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞
        applyYAxisToChart(fieldNum);
    }
}

// –°–∫–∞—á–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –∫–∞–∫ PNG
function downloadChart(fieldNum) {
    const canvas = document.getElementById(`chart-field${fieldNum}`);
    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = url;
    a.download = `channel-${channelId}-field${fieldNum}.png`;
    a.click();
}

// –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
function toggleAutoScroll(fieldNum) {
    const enabled = document.getElementById(`autoScroll${fieldNum}`).checked;
    
    if (enabled) {
        // –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        autoScrollIntervals[fieldNum] = setInterval(() => {
            loadLatestAndAppend(fieldNum);
        }, 10000);
    } else {
        clearInterval(autoScrollIntervals[fieldNum]);
        autoScrollIntervals[fieldNum] = null;
    }
}

// –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
async function loadLatestAndAppend(fieldNum) {
    const chart = charts[fieldNum];
    if (!chart || chart.data.labels.length === 0) return;
    
    const fieldName = `field${fieldNum}`;
    
    try {
        // –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ
        const response = await fetch(`/channels/${channelId}/feeds.json?results=10`);
        
        if (!response.ok) {
            console.error('HTTP error! status:', response.status);
            return;
        }
        
        const data = await response.json();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö
        if (!data || !data.feeds || !Array.isArray(data.feeds)) {
            console.error('Invalid data format in loadLatestAndAppend:', data);
            return;
        }
        
        const newFeeds = data.feeds.filter(f => f[fieldName] !== null).reverse();
        
        if (newFeeds.length === 0) return;
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        const lastLabel = chart.data.labels[chart.data.labels.length - 1];
        let hasNew = false;
        
        newFeeds.forEach(feed => {
            const label = new Date(feed.created_at).toLocaleString('ru-RU');
            if (label !== lastLabel && !chart.data.labels.includes(label)) {
                chart.data.labels.push(label);
                chart.data.datasets[0].data.push(feed[fieldName]);
                hasNew = true;
            }
        });
        
        if (hasNew) {
            // –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000)
            if (chart.data.labels.length > 1000) {
                chart.data.labels = chart.data.labels.slice(-1000);
                chart.data.datasets[0].data = chart.data.datasets[0].data.slice(-1000);
            }
            
            // –û–±–Ω–æ–≤–∏—Ç—å –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
            chart.update('none');
        }
        
    } catch (error) {
        console.error('Error loading latest data:', error);
    }
}

// Load charts on page load
document.addEventListener('DOMContentLoaded', loadCharts);

// Cleanup intervals on page unload
window.addEventListener('beforeunload', () => {
    Object.values(autoScrollIntervals).forEach(interval => {
        if (interval) clearInterval(interval);
    });
});

// ========== SVG WIDGETS ==========

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–∂–µ—Ç—ã –∏–∑ backend
const widgets = {{ widgets_json | safe }};

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SVG –≤–∏–¥–∂–µ—Ç–∞
function updateSvgWidget(widgetId, latestData) {
    const widget = widgets.find(w => w.id === widgetId);
    if (!widget || !widget.svg_bindings) return;
    
    const svgObject = document.getElementById(`svg-widget-${widgetId}`);
    if (!svgObject || !svgObject.contentDocument) return;
    
    try {
        const svgDoc = svgObject.contentDocument;
        const bindings = JSON.parse(widget.svg_bindings);
        
        bindings.forEach(binding => {
            const element = svgDoc.getElementById(binding.elementId);
            if (!element) return;
            
            const fieldValue = latestData[binding.field];
            if (fieldValue === null || fieldValue === undefined) return;
            
            // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç
            let value = binding.format.replace('{value}', fieldValue);
            
            // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ —Å–≤–æ–π—Å—Ç–≤—É
            switch(binding.property) {
                case 'textContent':
                    element.textContent = value;
                    break;
                case 'fill':
                    element.setAttribute('fill', value);
                    break;
                case 'stroke':
                    element.setAttribute('stroke', value);
                    break;
                case 'width':
                    element.setAttribute('width', fieldValue);
                    break;
                case 'height':
                    element.setAttribute('height', fieldValue);
                    break;
                case 'opacity':
                    element.setAttribute('opacity', fieldValue / 100);
                    break;
                case 'transform':
                    element.setAttribute('transform', value);
                    break;
            }
        });
    } catch (error) {
        console.error('Error updating SVG widget:', error);
    }
}

// –û–±–Ω–æ–≤–ª—è—Ç—å –≤—Å–µ SVG –≤–∏–¥–∂–µ—Ç—ã
async function updateAllSvgWidgets() {
    if (widgets.length === 0) return;
    
    try {
        const response = await fetch(`/channels/${channelId}/feeds/last.json`);
        const data = await response.json();
        
        widgets.forEach(widget => {
            updateSvgWidget(widget.id, data.feed);
        });
    } catch (error) {
        console.error('Error updating SVG widgets:', error);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å SVG –≤–∏–¥–∂–µ—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
setTimeout(() => {
    // –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∑–∫–∏ SVG –æ–±—ä–µ–∫—Ç–æ–≤
    const svgObjects = document.querySelectorAll('[id^="svg-widget-"]');
    svgObjects.forEach(obj => {
        obj.addEventListener('load', function() {
            updateAllSvgWidgets();
        });
    });
    
    // –ü–µ—Ä–≤–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    updateAllSvgWidgets();
}, 1000);

// –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ SVG –≤–∏–¥–∂–µ—Ç–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
if (widgets.length > 0) {
    setInterval(updateAllSvgWidgets, 5000);
}
</script>
{% endblock %}

